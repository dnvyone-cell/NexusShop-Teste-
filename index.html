<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Nexus App Store</title>
    
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Nexus">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/4712/4712109.png">
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/4712/4712109.png">

    <!-- Dependências Externas -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Firebase SDK Compat -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@400;500;600;700;800&family=Inter:wght@400;500;600;700;800;900&display=swap');
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            margin: 0; 
            background-color: #000000; 
            color: white;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            overflow: hidden;
            transition: background-color 0.5s cubic-bezier(0.32, 0.72, 0, 1);
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        @keyframes springUp { 
            0% { transform: translateY(60px) scale(0.9); opacity: 0; } 
            100% { transform: translateY(0) scale(1); opacity: 1; } 
        }
        
        @keyframes softFade {
            0% { opacity: 0; }
            100% { opacity: 1; }
        }

        @keyframes floatBot { 
            0%, 100% { transform: translateY(0); } 
            50% { transform: translateY(-8px); } 
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .view-animate { animation: softFade 0.5s cubic-bezier(0.25, 1, 0.5, 1) forwards; }
        .animate-spring { animation: springUp 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.1) forwards; }
        .animate-float { animation: floatBot 5s ease-in-out infinite; }
        .animate-shake { animation: shake 0.3s ease-in-out; }
        
        .onyx-card {
            background-color: #0c0c0e;
            border: 1px solid #1f1f23;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }

        .onyx-button {
            background-color: transparent;
            border: 1px solid #27272a; 
            color: #e4e4e7;
        }
        .onyx-button:active {
            background-color: #18181b;
            transform: scale(0.95);
        }

        .glass-dock {
            background: rgba(10, 10, 10, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 -10px 40px rgba(0,0,0,0.8);
        }
        
        .search-bar-floating {
            background: rgba(28, 28, 30, 0.85);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .btn-fluid { transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1), background-color 0.2s; }
        .btn-fluid:active { transform: scale(0.92); }

        .app-icon { border-radius: 22%; position: relative; overflow: hidden; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.4), inset 0 0 0 1px rgba(255,255,255,0.1); }
        .yt-iframe { pointer-events: none; width: 100%; height: 100%; object-fit: cover; }
        
        .file-input-wrapper { position: relative; overflow: hidden; display: inline-block; }
        .file-input-wrapper input[type=file] { font-size: 100px; position: absolute; left: 0; top: 0; opacity: 0; cursor: pointer; }

        .badge-mod {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            padding: 1px 6px;
            border-radius: 4px;
            font-size: 8px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-platform {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.6);
            padding: 1px 6px;
            border-radius: 4px;
            font-size: 8px;
            font-weight: 700;
            text-transform: uppercase;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        const APP_VERSION = "6.1.0 - Features Restored"; 

        const firebaseConfig = {
            apiKey: "AIzaSyDcWSyP6S7LDuGQ1ZjFqKAHCZ8mjwJhEKY",
            authDomain: "nexus-hub-159db.firebaseapp.com",
            projectId: "nexus-hub-159db",
            storageBucket: "nexus-hub-159db.firebasestorage.app",
            messagingSenderId: "400199878551",
            appId: "1:400199878551:web:4f58353584daffbeb026d2"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        const DB_APP_ID = 'nexus-hub-permanent-vault';

        const POPULAR_ICONS = ["Zap", "Star", "Flame", "Heart", "Gamepad2", "Trophy", "Award", "Crown", "Diamond", "Rocket", "Ghost", "Skull", "Joystick", "Dice5", "Swords", "Crosshair", "Target", "Monitor", "Smartphone", "Tablet", "Laptop", "Watch", "Headphones", "Speaker", "Music", "Video", "Image", "Camera", "Film", "Tv", "Radio", "Mic", "DownloadCloud", "UploadCloud", "CloudLightning", "Wifi", "Bluetooth", "Settings", "User", "Search", "Menu", "Grid", "List", "Filter", "Layers", "Check", "X", "Plus", "Minus", "Info", "AlertTriangle", "Bell", "Calendar", "ShoppingBag", "CreditCard", "DollarSign", "Tag", "Bookmark", "MapPin", "Globe"];

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const initAudio = () => { if (audioCtx.state === 'suspended') audioCtx.resume(); };
        window.addEventListener('click', initAudio, { once: true });
        window.addEventListener('touchstart', initAudio, { once: true });

        const playTone = (freq, type, duration, vol = 0.1, time = 0) => { try { const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); osc.type = type; osc.frequency.setValueAtTime(freq, audioCtx.currentTime + time); gain.gain.setValueAtTime(0, audioCtx.currentTime + time); gain.gain.linearRampToValueAtTime(vol, audioCtx.currentTime + time + 0.02); gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + time + duration); osc.connect(gain); gain.connect(audioCtx.destination); osc.start(audioCtx.currentTime + time); osc.stop(audioCtx.currentTime + time + duration); } catch(e) {} };
        const playSound = (name) => {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            switch (name) {
                case 'click': playTone(800, 'sine', 0.1, 0.2); break;
                case 'open': playTone(400, 'sine', 0.2, 0.2, 0); break;
                case 'close': playTone(300, 'sine', 0.15, 0.2, 0); break;
                case 'success': playTone(440, 'sine', 0.2, 0.3, 0); playTone(659, 'sine', 0.4, 0.3, 0.1); break;
                case 'lock': playTone(150, 'sawtooth', 0.3, 0.2); break;
            }
        };

        const ACCENT_COLORS = { blue: { hex: '#2563eb' }, purple: { hex: '#9333ea' }, green: { hex: '#16a34a' }, orange: { hex: '#ea580c' }, red: { hex: '#dc2626' } };
        const THEMES = { 
            amoled: { bg: 'bg-black', text: 'text-white', card: 'bg-[#0c0c0e]', border: 'border-[#1f1f23]', subtext: 'text-zinc-500', input: 'bg-[#1c1c1e]', dock: 'glass-dock' }, 
            matte: { bg: 'bg-[#18181b]', text: 'text-zinc-100', card: 'bg-[#27272a]', border: 'border-white/5', subtext: 'text-zinc-400', input: 'bg-[#3f3f46]', dock: 'bg-[#27272a]/90' }, 
            light: { bg: 'bg-[#f2f2f7]', text: 'text-black', card: 'bg-white', border: 'border-black/5', subtext: 'text-zinc-500', input: 'bg-white', dock: 'bg-white/80' } 
        };

        const openSystemLink = (url) => { playSound('click'); if (!url) return alert("Link indisponível."); window.open(url, '_blank'); };
        const toLocalDatetimeString = (timestamp) => { 
            if (!timestamp) return ""; 
            const date = new Date(timestamp); 
            const pad = (n) => n.toString().padStart(2, '0'); 
            return `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())}T${pad(date.getHours())}:${pad(date.getMinutes())}`; 
        };
        const formatShortDate = (timestamp) => { if (!timestamp) return ""; const date = new Date(timestamp); return date.toLocaleDateString('pt-PT', { day: '2-digit', month: 'short' }).toUpperCase(); };
        const getYouTubeID = (url) => { if (!url) return null; const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/; const match = url.match(regExp); return (match && match[2].length === 11) ? match[2] : null; };

        // Components
        function Icon({ name, size = 24, className = "", style = {} }) { const containerRef = useRef(null); useEffect(() => { if (window.lucide && containerRef.current && name) { const kebabName = name.replace(/([a-z0-9])([A-Z])/g, '$1-$2').toLowerCase(); containerRef.current.innerHTML = `<i data-lucide="${kebabName}"></i>`; window.lucide.createIcons({ root: containerRef.current, attrs: { strokeWidth: 2, width: size, height: size, class: className, style: style } }); } }, [name, size, className, style]); return <span ref={containerRef} className="flex items-center justify-center pointer-events-none"></span>; }
        function NexusBot({ mode = 'static', message, accentColor, onComplete }) { useEffect(() => { if (mode === 'greeting') { const t = setTimeout(onComplete, 2500); return () => clearTimeout(t); } }, [mode, onComplete]); if (mode !== 'greeting') return null; return (<div className="fixed inset-0 z-[9999] bg-black/95 backdrop-blur-xl flex flex-col items-center justify-center view-animate"><div className="animate-float relative"><div className="w-24 h-24 bg-zinc-900 rounded-[30px] border-[2px] border-zinc-800 shadow-[0_0_50px_rgba(0,0,0,0.5)] flex items-center justify-center relative overflow-hidden"><div className="flex gap-4"><div className="w-4 h-6 rounded-full animate-blink" style={{backgroundColor: accentColor}}></div><div className="w-4 h-6 rounded-full animate-blink" style={{backgroundColor: accentColor}}></div></div></div></div><h2 className="mt-8 text-xl font-bold text-white tracking-tight" dangerouslySetInnerHTML={{ __html: message }}></h2></div>); }
        function IOSSwitch({ checked, onChange, accentColor }) { return (<div onClick={() => { playSound('click'); onChange(!checked); }} className={`relative w-[52px] h-[32px] rounded-full transition-all duration-300 cursor-pointer shadow-inner ${checked ? '' : 'bg-zinc-800'}`} style={{ backgroundColor: checked ? accentColor : undefined }}><div className={`absolute top-[2px] w-[28px] h-[28px] bg-white rounded-full shadow-lg transition-all duration-300 cubic-bezier(0.34, 1.56, 0.64, 1) ${checked ? 'left-[22px]' : 'left-[2px]'}`}></div></div>); }
        function InputField({ label, value, onChange, type = "text", placeholder = "", themeMode, accentColor }) { const colors = THEMES[themeMode] || THEMES.amoled; return (<div className="mb-5 w-full text-left group"><label className={`block text-[10px] font-bold mb-2 uppercase tracking-wide ml-3 transition-colors ${colors.subtext} group-focus-within:${colors.text}`}>{label}</label><input type={type} value={value} onChange={(e) => onChange(e.target.value)} placeholder={placeholder} className={`w-full rounded-[20px] px-6 py-4 ${colors.input} ${colors.text} placeholder:opacity-30 border border-transparent outline-none font-medium text-sm transition-all focus:border-[${accentColor}] focus:shadow-[0_0_0_4px_rgba(255,255,255,0.05)]`} style={{ caretColor: accentColor }} /></div>); }
        function TabButton({ active, icon, label, onClick, themeMode, accentColor }) { const colors = THEMES[themeMode] || THEMES.amoled; return (<button onClick={() => { playSound('click'); onClick(); }} className="flex flex-col items-center justify-center flex-1 gap-1 btn-fluid outline-none group py-1"><div className={`transition-all duration-300 ${active ? '-translate-y-1' : ''}`} style={{ color: active ? accentColor : undefined }} className={!active ? colors.subtext : ''}><Icon name={icon} size={22} strokeWidth={active ? 2.5 : 2} /></div><span className={`text-[9px] font-bold uppercase tracking-widest ${active ? 'opacity-100' : 'opacity-40'} transition-opacity`} style={{ color: active ? accentColor : undefined }}>{label}</span></button>); }
        
        function VideoPlayer({ url, image }) { 
            const ytId = useMemo(() => getYouTubeID(url), [url]); 
            if (!url) return <img src={image} className="absolute inset-0 w-full h-full object-cover" />; 
            if (ytId) { 
                return (
                    <div className="absolute inset-0 bg-black overflow-hidden rounded-[inherit]">
                        <iframe 
                            src={`https://www.youtube.com/embed/${ytId}?autoplay=1&mute=1&controls=0&loop=1&playlist=${ytId}&playsinline=1&showinfo=0&rel=0&iv_load_policy=3&modestbranding=1`} 
                            className="absolute inset-0 w-full h-full object-cover pointer-events-none scale-[1.2]" 
                            frameBorder="0" 
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                        ></iframe>
                        <div className="absolute inset-0 bg-transparent z-10"></div>
                    </div>
                ); 
            } 
            return <video src={url} poster={image} autoPlay loop muted playsInline className="absolute inset-0 w-full h-full object-cover" />; 
        }
        
        function AppListItem({ app, onClick, isAdmin, lockedAppId, now, themeMode, accentColor }) { 
            const colors = THEMES[themeMode] || THEMES.amoled; 
            const isPreOrder = app.scheduledAt && now < app.scheduledAt; 
            const unlockTime = app.unlockSurpriseAt || app.scheduledAt; 
            const isEffectiveLocked = app.isLocked && (!unlockTime || now < unlockTime); 
            const isShake = lockedAppId === app.id; 
            
            const handleQuickDownload = (e) => { e.stopPropagation(); if (isPreOrder) return; playSound('click'); openSystemLink(app.downloadUrl); }; 
            
            return (
                <div onClick={onClick} className={`flex items-center gap-4 p-4 mb-3 rounded-[28px] ${colors.card} border ${colors.border} active:scale-[0.97] transition-all cursor-pointer group relative ${isShake ? 'animate-shake' : ''}`}>
                    <div className="relative shrink-0 transition-transform duration-300 group-active:scale-95">
                        {isEffectiveLocked ? (
                            <div className={`w-[60px] h-[60px] rounded-[18px] bg-black/40 flex items-center justify-center border ${colors.border} shadow-inner`}>
                                <span className={`text-2xl font-black ${colors.subtext}`}>?</span>
                            </div>
                        ) : (
                            <img src={app.icon} className="w-[60px] h-[60px] app-icon object-cover bg-zinc-800" />
                        )}
                    </div>
                    <div className="flex-1 min-w-0 flex flex-col justify-center">
                        <div className="flex justify-between items-center gap-2">
                            <div className="flex-1 min-w-0">
                                <div className="flex items-center gap-2 mb-0.5">
                                    <h4 className={`font-bold text-[15px] leading-tight truncate ${colors.text} ${isEffectiveLocked ? 'opacity-50' : ''}`}>
                                        {isEffectiveLocked ? "Confidencial" : app.name}
                                    </h4>
                                    {!isEffectiveLocked && app.isMod && <span className="badge-mod">MOD</span>}
                                </div>
                                <div className="flex items-center gap-2">
                                    <p className={`text-[12px] font-medium truncate ${colors.subtext}`}>
                                        {isEffectiveLocked ? "Em breve..." : app.category}
                                    </p>
                                    {!isEffectiveLocked && app.platform && (
                                        <span className="badge-platform">{app.platform}</span>
                                    )}
                                </div>
                            </div>
                            <button onClick={handleQuickDownload} style={{ color: isPreOrder ? undefined : accentColor, backgroundColor: isPreOrder ? undefined : `${accentColor}15` }} className={`rounded-full px-4 py-1.5 text-[10px] font-black tracking-wider uppercase transition-all active:scale-90 ${isPreOrder ? `bg-zinc-800 text-zinc-500 opacity-50` : ''}`}>
                                {isPreOrder ? 'AGUARDE' : 'OBTER'}
                            </button>
                        </div>
                    </div>
                </div>
            ); 
        }

        function SearchAppCard({ app, onClick, now, themeMode, accentColor }) { 
            const colors = THEMES[themeMode] || THEMES.amoled; 
            const isPreOrder = app.scheduledAt && now < app.scheduledAt; 
            const unlockTime = app.unlockSurpriseAt || app.scheduledAt; 
            const isEffectiveLocked = app.isLocked && (!unlockTime || now < unlockTime); 
            
            const handleDownload = (e) => { e.stopPropagation(); if(isPreOrder) return; playSound('click'); openSystemLink(app.downloadUrl); }; 
            
            return (
                <div onClick={onClick} className={`mb-6 p-5 rounded-[32px] ${colors.card} border ${colors.border} cursor-pointer group active:scale-[0.98] transition-transform duration-200`}>
                    <div className="flex justify-between items-center mb-5">
                        <div className="flex gap-4 items-center">
                            {isEffectiveLocked ? (
                                <div className="w-[64px] h-[64px] rounded-[20px] bg-black/40 flex items-center justify-center border border-zinc-800/50">
                                    <span className="text-2xl font-black text-zinc-600">?</span>
                                </div>
                            ) : (
                                <img src={app.icon} className="w-[64px] h-[64px] rounded-[20px] shadow-lg border border-white/5 bg-zinc-800 object-cover" />
                            )}
                            <div>
                                <div className="flex items-center gap-2">
                                    <h3 className={`font-bold text-[17px] leading-tight ${colors.text} mb-0.5`}>
                                        {isEffectiveLocked ? 'Confidencial' : app.name}
                                    </h3>
                                    {!isEffectiveLocked && app.isMod && <span className="badge-mod">MOD</span>}
                                </div>
                                <div className="flex items-center gap-2">
                                    <p className="text-[13px] text-zinc-500 font-medium">
                                        {isEffectiveLocked ? '???' : app.category}
                                    </p>
                                    {!isEffectiveLocked && app.platform && <span className="badge-platform">{app.platform}</span>}
                                </div>
                            </div>
                        </div>
                        <div className="flex flex-col items-center">
                            <button onClick={handleDownload} style={{color: accentColor, backgroundColor: `${accentColor}15`}} className="rounded-full px-5 py-2 text-[11px] font-black uppercase tracking-widest transition-all active:scale-95 shadow-sm">
                                {isPreOrder ? 'AGUARDE' : 'OBTER'}
                            </button>
                        </div>
                    </div>
                    {!isEffectiveLocked && (
                        <div className="flex gap-3 overflow-hidden">
                            {(app.screenshots && app.screenshots.length > 0 ? app.screenshots.slice(0, 3) : [app.icon]).map((shot, idx) => (
                                <div key={idx} className="flex-1 aspect-[9/19] rounded-[22px] overflow-hidden border border-white/5 bg-black/20 relative">
                                    <img src={shot} className="w-full h-full object-cover" />
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            ); 
        }

        function QuickAccessCard({ icon, label, title, onClick }) { return (<div onClick={onClick} className="onyx-card w-40 h-40 rounded-[32px] p-5 flex flex-col justify-between shrink-0 snap-start active:scale-95 transition-transform cursor-pointer relative overflow-hidden group"><div className="w-10 h-10 rounded-full border border-zinc-800 bg-black flex items-center justify-center text-zinc-300 group-hover:text-white transition-colors z-10"><Icon name={icon || 'Zap'} size={18} /></div><div className="z-10"><p className="text-[9px] font-bold text-zinc-500 uppercase tracking-widest mb-1">{label}</p><h3 className="text-xl font-bold text-white leading-tight">{title}</h3></div></div>); }
        
        function CollectionModal({ collection, apps, onClose, onApp, accentColor }) { const now = Date.now(); const filteredApps = apps.filter(a => { if (collection.actionType === 'filter') { return a.category === collection.actionValue && (!a.scheduledAt || now >= a.scheduledAt || a.isVisibleBeforeLaunch); } return false; }); return (<div className="fixed inset-0 z-[150] bg-black view-animate flex flex-col"><header className="px-6 pt-14 pb-4 flex justify-between items-center bg-black/90 backdrop-blur-xl sticky top-0 z-20"><div><p className="text-[10px] font-bold text-zinc-500 uppercase tracking-widest mb-1">{collection.label}</p><h1 className="text-3xl font-extrabold tracking-tight text-white">{collection.title}</h1></div><button onClick={onClose} style={{color: accentColor}} className="w-10 h-10 rounded-full bg-[#1c1c1e] flex items-center justify-center font-bold"><Icon name="X" size={20} /></button></header><div className="p-6 space-y-2 overflow-y-auto pb-40">{filteredApps.length === 0 ? (<div className="text-center text-zinc-500 mt-10">Nenhum app encontrado nesta coleção.</div>) : (filteredApps.map(app => (<AppListItem key={app.id} app={app} onClick={() => onApp(app)} now={now} themeMode="amoled" accentColor={accentColor} />)))}</div></div>); }

        function AppDetail({ app, onClose, themeMode, accentColor }) {
            const now = Date.now();
            const colors = THEMES[themeMode] || THEMES.amoled;
            const isPreOrder = app.scheduledAt && now < app.scheduledAt;
            const isEffectiveLocked = app.isLocked && (!app.unlockSurpriseAt && (!app.scheduledAt || now < app.scheduledAt));
            const [showWarning, setShowWarning] = useState(!!app.hasWarning);
            const [reviews, setReviews] = useState([]);
            const [userRating, setUserRating] = useState(0);
            const [commentText, setCommentText] = useState("");
            const [avgRating, setAvgRating] = useState(parseFloat(app.rating) || 4.8);
            const currentUser = localStorage.getItem('nexus_username');

            useEffect(() => {
                const unsub = db.collection('artifacts').doc(DB_APP_ID).collection('public').doc('data').collection('reviews')
                    .where('appId', '==', app.id)
                    .onSnapshot(snap => {
                        const loadedReviews = snap.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b) => b.createdAt - a.createdAt);
                        setReviews(loadedReviews);
                        if (loadedReviews.length > 0) {
                            const sum = loadedReviews.reduce((acc, r) => acc + (r.rating || 0), 0);
                            setAvgRating((sum / loadedReviews.length).toFixed(1));
                        }
                    }, err => console.log(err));
                return () => unsub();
            }, [app.id]);

            const handleSubmitReview = async () => {
                if(!currentUser) return alert("Você precisa estar logado para comentar.");
                if(userRating === 0) return alert("Escolha uma nota de 1 a 5.");
                if(!commentText.trim()) return alert("Escreva um comentário.");
                try {
                    const userDoc = await db.collection('artifacts').doc(DB_APP_ID).collection('public').doc('accounts').collection('users').doc(currentUser).get();
                    const userImage = userDoc.exists ? userDoc.data().image : '';
                    await db.collection('artifacts').doc(DB_APP_ID).collection('public').doc('data').collection('reviews').add({
                        appId: app.id,
                        username: currentUser,
                        userImage: userImage,
                        rating: userRating,
                        comment: commentText,
                        createdAt: Date.now()
                    });
                    setCommentText("");
                    setUserRating(0);
                    playSound('success');
                } catch(e) { alert("Erro ao enviar: " + e.message); }
            };

            const handleShare = async () => {
                playSound('click');
                const shareData = { title: `Nexus - ${app.name}`, text: `Veja este app incrível na Nexus Store: ${app.name}`, url: window.location.href };
                try {
                    if (navigator.share) await navigator.share(shareData);
                    else {
                        const dummy = document.createElement('input');
                        document.body.appendChild(dummy);
                        dummy.value = window.location.href;
                        dummy.select();
                        document.execCommand('copy');
                        document.body.removeChild(dummy);
                        alert("Link copiado!");
                    }
                } catch (err) { console.log("Erro ao partilhar:", err); }
            };

            const displayApp = isEffectiveLocked ? { ...app, name: "???", developer: "???", description: "Conteúdo confidencial.", icon: null } : app;
            const hasDependency = app.dependencyUrl && app.dependencyName;

            return (
                <div className={`fixed inset-0 z-[100] ${colors.bg} ${colors.text} view-animate flex flex-col overflow-y-auto pb-10`}>
                    {showWarning && (
                        <div className="fixed inset-0 z-[110] bg-black/90 backdrop-blur-md flex items-center justify-center p-8 animate-spring">
                            <div className={`${colors.card} p-6 rounded-[30px] w-full max-w-sm shadow-2xl text-center border ${colors.border}`}>
                                <div className="w-12 h-12 bg-yellow-500/10 rounded-full flex items-center justify-center mx-auto mb-4"><Icon name="AlertTriangle" className="text-yellow-500" size={24} /></div>
                                <h3 className="font-bold text-lg mb-2">Atenção</h3>
                                <p className={`${colors.subtext} text-sm mb-6 leading-relaxed`}>{app.warningMessage}</p>
                                <button onClick={() => setShowWarning(false)} style={{backgroundColor: accentColor}} className={`w-full py-3 text-white font-bold rounded-xl text-sm btn-fluid`}>Entendido</button>
                            </div>
                        </div>
                    )}

                    <div className={`sticky top-0 z-30 flex justify-between items-center p-6 ${colors.bg}/80 backdrop-blur-xl`}>
                        <button onClick={() => { playSound('click'); onClose(); }} style={{color: accentColor}} className={`w-10 h-10 rounded-full ${colors.input} flex items-center justify-center backdrop-blur-md btn-fluid`}><Icon name="ChevronLeft" size={24} /></button>
                        <button onClick={handleShare} style={{color: accentColor}} className={`w-10 h-10 rounded-full ${colors.input} flex items-center justify-center backdrop-blur-md btn-fluid`}><Icon name="Share" size={20} /></button>
                    </div>

                    <div className="px-6 animate-spring">
                        <div className="flex flex-col items-center text-center mb-8">
                            <div className={`w-36 h-36 rounded-[32px] shadow-2xl overflow-hidden mb-6 ${isEffectiveLocked ? `bg-zinc-900 flex items-center justify-center` : ''} app-icon`}>
                                {isEffectiveLocked ? <span className={`text-6xl font-black text-zinc-700`}>?</span> : <img src={displayApp.icon} className="w-full h-full object-cover" />}
                            </div>
                            <div className="flex items-center gap-3 mb-1">
                                <h1 className="text-3xl font-black leading-tight tracking-tight">{displayApp.name}</h1>
                                {!isEffectiveLocked && app.isMod && <span className="badge-mod text-xs px-2 py-0.5">MOD</span>}
                            </div>
                            <p className={`${colors.subtext} text-sm font-medium mb-6 uppercase tracking-wide opacity-80`}>{displayApp.developer}</p>
                            <button onClick={() => !isPreOrder && openSystemLink(app.downloadUrl)} disabled={isPreOrder} style={{ backgroundColor: isPreOrder ? undefined : accentColor }} className={`w-full max-w-[200px] py-4 rounded-full font-bold text-sm uppercase tracking-wider transition-transform active:scale-95 shadow-lg ${isPreOrder ? 'bg-zinc-800 text-zinc-500 shadow-none' : 'text-white'}`}>
                                {isPreOrder ? 'EM BREVE' : 'OBTER'}
                            </button>
                        </div>
                        
                        <div className={`flex justify-between border-y ${colors.border} py-5 mb-8 overflow-x-auto`}>
                            <div className={`px-2 text-center flex-1 border-r ${colors.border}`}>
                                <p className={`text-[10px] ${colors.subtext} font-bold uppercase mb-1`}>Classificação</p>
                                <p className={`text-xl font-bold ${colors.text}`}>{avgRating}</p>
                                <div className="flex justify-center text-zinc-500">
                                    {[1,2,3,4,5].map(i => <Icon key={i} name="Star" size={10} fill={i <= Math.round(avgRating) ? "currentColor" : "none"} />)}
                                </div>
                            </div>
                            <div className={`px-2 text-center flex-1 border-r ${colors.border}`}>
                                <p className={`text-[10px] ${colors.subtext} font-bold uppercase mb-1`}>Categoria</p>
                                <Icon name="Grid" size={22} className={`mx-auto ${colors.subtext} mb-1`} />
                                <p className={`text-[9px] ${colors.subtext}`}>{displayApp.category}</p>
                            </div>
                            <div className="px-2 text-center flex-1">
                                <p className={`text-[10px] ${colors.subtext} font-bold uppercase mb-1`}>Plataforma</p>
                                <p className={`text-sm font-bold ${colors.subtext} mt-1.5`}>{displayApp.platform || 'Mobile'}</p>
                            </div>
                        </div>

                        {hasDependency && (
                            <div className={`mb-8 p-4 rounded-[24px] border border-blue-500/20 bg-blue-500/5 flex items-center justify-between`}>
                                <div className="flex items-center gap-3">
                                    <img src={app.dependencyIcon || "https://cdn-icons-png.flaticon.com/512/2099/2099192.png"} className="w-12 h-12 rounded-xl bg-zinc-800 object-cover shadow-sm" />
                                    <div>
                                        <p className="text-[10px] font-bold text-blue-500 uppercase flex items-center gap-1"><Icon name="Info" size={10} /> Dependência</p>
                                        <p className={`font-bold text-sm ${colors.text}`}>{app.dependencyName}</p>
                                    </div>
                                </div>
                                <button onClick={() => openSystemLink(app.dependencyUrl)} style={{backgroundColor: accentColor}} className="px-4 py-2 rounded-xl text-xs font-bold text-white shadow-lg active:scale-95 transition-transform">Baixar</button>
                            </div>
                        )}

                        <div className="mb-8">
                            <h2 className="text-xl font-bold mb-3 tracking-tight">Novidades</h2>
                            <div className={`flex justify-between ${colors.subtext} text-xs font-bold mb-3`}>
                                <span className={`${colors.input} px-2 py-1 rounded-md ${colors.text}`}>Versão {displayApp.version || '1.0'}</span>
                                <span>{formatShortDate(app.lastUpdated || now)}</span>
                            </div>
                            <p className={`${colors.subtext} text-sm leading-relaxed`}>{displayApp.updateNews || 'Melhorias de desempenho e correções de bugs.'}</p>
                        </div>

                         <div className="mb-8">
                            <h2 className="text-xl font-bold mb-4 tracking-tight">Pré-visualização</h2>
                            <div className="flex gap-4 overflow-x-auto no-scrollbar snap-x -mx-6 px-6">
                                {displayApp.screenshots?.map((s, i) => <img key={i} src={s} className={`h-[400px] w-auto rounded-[32px] snap-center shadow-2xl ${colors.input} object-cover border ${colors.border}`} />)}
                            </div>
                        </div>

                        <div className={`border-t ${colors.border} pt-8 mb-8`}>
                            <p className={`${colors.subtext} text-sm leading-relaxed whitespace-pre-wrap opacity-90`}>{displayApp.description}</p>
                        </div>

                        <div className={`border-t ${colors.border} pt-8`}>
                            <h2 className="text-xl font-bold mb-6 tracking-tight">Avaliações e Opiniões</h2>
                            <div className={`${colors.card} p-5 rounded-[24px] border ${colors.border} mb-6`}>
                                <div className="text-center mb-4">
                                    <p className={`text-4xl font-black ${colors.text}`}>{avgRating}</p>
                                    <p className={`text-xs ${colors.subtext} font-bold uppercase tracking-widest`}>de 5</p>
                                </div>
                                <div className="flex justify-center gap-2 mb-4">
                                    {[1, 2, 3, 4, 5].map((star) => (
                                        <button key={star} onClick={() => { playSound('click'); setUserRating(star); }} className={`transition-transform active:scale-90 ${star <= userRating ? 'text-yellow-400' : colors.subtext}`}>
                                            <Icon name="Star" size={32} fill={star <= userRating ? "currentColor" : "none"} strokeWidth={star <= userRating ? 0 : 2} />
                                        </button>
                                    ))}
                                </div>
                                <textarea className={`w-full ${colors.input} rounded-xl p-3 text-sm ${colors.text} outline-none border ${colors.border} focus:border-white/20 h-24 mb-3 resize-none`} placeholder={currentUser ? "Escreva sua opinião..." : "Faça login para comentar"} value={commentText} onChange={e => setCommentText(e.target.value)} disabled={!currentUser} />
                                {currentUser ? <button onClick={handleSubmitReview} style={{backgroundColor: accentColor}} className="w-full py-3 rounded-xl font-bold text-white text-sm shadow-lg active:scale-95 transition-transform">Enviar Avaliação</button> : <p className="text-center text-xs text-red-400 font-bold">Faça login para enviar</p>}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        function TodayView({ apps, highlights, quickAccess, onProfile, onSettings, onApp, onQuickAccess, isAdmin, profileImage, themeMode, accentColor }) {
            const now = Date.now(); 
            const colors = THEMES[themeMode] || THEMES.amoled;
            const [lockedAppId, setLockedAppId] = useState(null); 
            const activeHighlights = highlights.filter(h => { if(h.isHidden) return false; const isLive = !h.scheduledAt || now >= h.scheduledAt; return isLive; }).sort((a,b) => (a.order || 99) - (b.order || 99)); 
            
            const stories = activeHighlights.filter(h => !h.displayMode || h.displayMode === 'story'); 
            const widgets = activeHighlights.filter(h => h.displayMode === 'widget'); 
            const comingSoonApps = apps.filter(a => a.scheduledAt && now < a.scheduledAt && a.isVisibleBeforeLaunch).sort((a,b) => a.scheduledAt - b.scheduledAt).slice(0, 3); 
            const updatesApps = apps.filter(a => a.lastUpdated && (now - a.lastUpdated < 86400000)).sort((a,b) => b.lastUpdated - a.lastUpdated); 
            const releasedApps = apps.filter(a => !a.scheduledAt || now >= a.scheduledAt); 
            const dateObj = new Date(); 
            const dayName = dateObj.toLocaleDateString('pt-PT', { weekday: 'long' }).toUpperCase(); 
            const dayNum = dateObj.getDate(); 

            const handleAppClick = (app) => { 
                const unlockTime = app.unlockSurpriseAt || app.scheduledAt; 
                const isEffectiveLocked = app.isLocked && (!unlockTime || now < unlockTime); 
                if (isEffectiveLocked) { setLockedAppId(app.id); playSound('lock'); setTimeout(() => setLockedAppId(null), 500); return; } 
                onApp(app); 
            };

            return (
                <div className={`view-animate ${colors.bg} min-h-screen pb-40 relative`}>
                    <header className={`pt-16 px-6 pb-2 flex justify-between items-end ${colors.bg} sticky top-0 z-40`}>
                        <div>
                            <p className={`text-[13px] font-bold ${colors.subtext} uppercase tracking-widest mb-1`}>{dayName}, {dayNum}</p>
                            <h1 className={`text-4xl font-black ${colors.text} tracking-tighter`}>Hoje</h1>
                        </div>
                        <div className="flex gap-3 mb-1">
                            {isAdmin && (<button onClick={() => { playSound('click'); onSettings(); }} className={`w-10 h-10 rounded-full ${colors.input} flex items-center justify-center transition-all border ${colors.border}`}><Icon name="Settings" size={18} /></button>)}
                            <button onClick={() => { playSound('click'); onProfile(); }} className={`w-10 h-10 rounded-full ${colors.input} flex items-center justify-center overflow-hidden transition-all border ${colors.border}`}>{profileImage ? <img src={profileImage} className="w-full h-full object-cover" /> : <Icon name="User" size={18} />}</button>
                        </div>
                    </header>
                    
                    <div className="space-y-10 px-6 pt-8">
                        {quickAccess.length > 0 && (
                            <section>
                                <h2 className={`text-xl font-bold ${colors.text} mb-4 tracking-tight`}>Acesso Rápido</h2>
                                <div className="flex gap-4 overflow-x-auto no-scrollbar snap-x -mx-6 px-6 pb-2">
                                    {quickAccess.map(qa => (<QuickAccessCard key={qa.id} icon={qa.icon} label={qa.label} title={qa.title} onClick={() => { playSound('click'); onQuickAccess(qa); }} />))}
                                </div>
                            </section>
                        )}
                        
                        {stories.length > 0 && (
                            <section>
                                <h2 className={`text-xl font-bold ${colors.text} mb-4 tracking-tight`}>Histórias</h2>
                                <div className="flex overflow-x-auto gap-4 no-scrollbar -mx-6 px-6 snap-x snap-mandatory">
                                    {stories.map(h => (
                                        <div key={h.id} className={`snap-center shrink-0 w-[80vw] max-w-[320px] aspect-[4/5] overflow-hidden relative rounded-[32px] btn-fluid cursor-pointer ${colors.card} border ${colors.border}`} onClick={() => { if(h.type !== 'mosaic' && h.appId) { playSound('open'); onApp(apps.find(a => a.id === h.appId)); }}}>
                                            {h.type === 'mosaic' ? (
                                                <div className="flex flex-col gap-2 h-full p-2">
                                                    <div className="w-full h-[60%] rounded-[24px] overflow-hidden relative shadow-lg" onClick={(e) => { e.stopPropagation(); playSound('open'); h.items && h.items[0].appId && onApp(apps.find(a => a.id === h.items[0].appId)) }}><img src={h.items[0].image} className="w-full h-full object-cover" /></div>
                                                    <div className="flex gap-2 w-full h-[40%]">{[1, 2].map(idx => (<div key={idx} className="flex-1 rounded-[20px] overflow-hidden relative shadow-lg" onClick={(e) => { e.stopPropagation(); playSound('open'); h.items && h.items[idx].appId && onApp(apps.find(a => a.id === h.items[idx].appId)) }}><img src={h.items[idx].image} className="w-full h-full object-cover" /></div>))}</div>
                                                </div>
                                            ) : (
                                                <>
                                                    <VideoPlayer url={h.videoUrl} image={h.image} />
                                                    <div className="absolute inset-0 bg-gradient-to-t from-black/90 via-transparent to-transparent p-6 flex flex-col justify-end">
                                                        <p className="text-[10px] font-bold text-zinc-300 uppercase tracking-widest mb-1 shadow-black">{h.subtitle}</p>
                                                        <h2 className="text-3xl font-extrabold text-white uppercase leading-[0.9] drop-shadow-lg">{h.title}</h2>
                                                    </div>
                                                </>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            </section>
                        )}
                        
                        {widgets.length > 0 && (
                            <section>
                                <div className="grid grid-cols-2 gap-4">
                                    {widgets.map(w => (
                                        <div key={w.id} onClick={() => { if(w.appId) { playSound('open'); onApp(apps.find(a => a.id === w.appId)); }}} className={`rounded-[28px] overflow-hidden relative shadow-lg btn-fluid cursor-pointer ${colors.card} border ${colors.border} ${w.cardSize === 'full' ? 'col-span-2 aspect-[2/1]' : 'col-span-1 aspect-square'}`}>
                                            <img src={w.image} className="w-full h-full object-cover" />
                                            <div className="absolute inset-0 bg-gradient-to-t from-black/90 via-transparent to-transparent p-4 flex flex-col justify-end">
                                                <p className="text-[9px] font-bold text-zinc-300 uppercase tracking-wider mb-1">{w.subtitle}</p>
                                                <h3 className={`${w.cardSize === 'full' ? 'text-2xl' : 'text-sm'} font-extrabold text-white uppercase leading-none drop-shadow-md`}>{w.title}</h3>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </section>
                        )}
                        
                        {comingSoonApps.length > 0 && (
                            <section>
                                <h3 className="text-lg font-bold mb-4 tracking-tight" style={{color: accentColor}}>Em Breve</h3>
                                <div className="space-y-1">{comingSoonApps.map(app => <AppListItem key={app.id} app={app} onClick={() => handleAppClick(app)} isAdmin={isAdmin} lockedAppId={lockedAppId} now={now} themeMode={themeMode} accentColor={accentColor} />)}</div>
                            </section>
                        )}
                        
                        {updatesApps.length > 0 && (
                            <section>
                                <h3 className="text-lg font-bold mb-4 tracking-tight" style={{color: accentColor}}>Novidades</h3>
                                <div className="space-y-1">{updatesApps.map(app => <AppListItem key={app.id} app={app} onClick={() => handleAppClick(app)} isAdmin={isAdmin} lockedAppId={lockedAppId} now={now} themeMode={themeMode} accentColor={accentColor} />)}</div>
                            </section>
                        )}
                        
                        {Array.from(new Set(releasedApps.map(a => a.category))).map(cat => (
                            <section key={cat}>
                                <h3 className={`text-lg font-bold mb-4 ${colors.text} border-b ${colors.border} pb-2 tracking-tight`}>{cat}</h3>
                                <div className="space-y-1">{releasedApps.filter(a => a.category === cat).map(app => <AppListItem key={app.id} app={app} onClick={() => handleAppClick(app)} isAdmin={isAdmin} lockedAppId={lockedAppId} now={now} themeMode={themeMode} accentColor={accentColor} />)}</div>
                            </section>
                        ))}
                    </div>
                </div>
            );
        }

        function CategorizedView({ title, categoryFilter, apps, onApp, themeMode, accentColor }) {
            const now = Date.now();
            const colors = THEMES[themeMode] || THEMES.amoled;
            const filtered = apps.filter(a => a.category === categoryFilter && (!a.scheduledAt || now >= a.scheduledAt || a.isVisibleBeforeLaunch));
            return (
                <div className={`view-animate ${colors.bg} min-h-screen pb-40 relative`}>
                    <header className={`pt-16 px-6 pb-6 sticky top-0 z-40 ${colors.bg}/90 backdrop-blur-md`}>
                        <h1 className={`text-4xl font-black ${colors.text} tracking-tighter`}>{title}</h1>
                    </header>
                    <div className="px-6 space-y-2 pt-2">
                        {filtered.length === 0 ? (
                            <div className={`text-center py-20 ${colors.subtext}`}>Nenhum item disponível.</div>
                        ) : filtered.map(app => (
                            <AppListItem key={app.id} app={app} onClick={() => onApp(app)} now={now} themeMode={themeMode} accentColor={accentColor} />
                        ))}
                    </div>
                </div>
            );
        }

        function SearchView({ apps, onApp, onProfile, profileImage, themeMode, accentColor }) { 
            const [query, setQuery] = useState(''); 
            const now = Date.now(); 
            const colors = THEMES[themeMode] || THEMES.amoled;
            const filtered = apps.filter(a => a.name.toLowerCase().includes(query.toLowerCase()) && (!a.scheduledAt || now >= a.scheduledAt || a.isVisibleBeforeLaunch)); 
            
            return (
                <div className={`view-animate ${colors.bg} min-h-screen transition-colors duration-300 relative`}>
                    <header className={`pt-16 px-6 pb-2 sticky top-0 z-20 ${colors.bg}/95 backdrop-blur-md`}>
                        <h1 className={`text-4xl font-black tracking-tighter ${colors.text} mb-2`}>Busca</h1>
                    </header>
                    <div className="px-5 pt-4 pb-48 space-y-4">
                        {filtered.length === 0 ? (
                            <div className="text-center mt-20 opacity-50">
                                <Icon name="Search" size={48} className={`mx-auto mb-4 ${colors.subtext}`} />
                                <p className={`font-bold ${colors.subtext}`}>Comece a digitar...</p>
                            </div>
                        ) : (
                            filtered.map(app => (
                                <SearchAppCard key={app.id} app={app} onClick={() => onApp(app)} now={now} themeMode={themeMode} accentColor={accentColor} />
                            ))
                        )}
                    </div>
                    <div className="fixed bottom-28 left-1/2 -translate-x-1/2 w-[90%] max-w-[400px] z-40">
                        <div className="search-bar-floating rounded-[24px] flex items-center px-4 py-3 gap-3">
                            <Icon name="Search" size={20} className="text-zinc-400" />
                            <input className="bg-transparent flex-1 text-[16px] text-white outline-none placeholder:text-zinc-500 font-medium" placeholder="Jogos, Apps, Histórias..." value={query} onChange={(e) => setQuery(e.target.value)} autoFocus={false} />
                            {query && (<button onClick={() => setQuery('')} className="bg-zinc-700 rounded-full p-1 text-black hover:bg-zinc-600 transition"><Icon name="X" size={12} /></button>)}
                        </div>
                    </div>
                </div>
            ); 
        }
        
        function QuickAccessManager({ quickAccess, onClose, accentColor }) { const [form, setForm] = useState({ title: '', label: 'DESTAQUE', icon: 'Zap', actionType: 'filter', actionValue: '', order: 1 }); const [editingId, setEditingId] = useState(null); const [showIconPicker, setShowIconPicker] = useState(false); const [confirmDeleteId, setConfirmDeleteId] = useState(null); const handleSubmit = async () => { if(!form.title) return; try { const coll = db.collection('artifacts').doc(DB_APP_ID).collection('public').doc('data').collection('quickAccess'); if(editingId) { await coll.doc(editingId).update(form); setEditingId(null); } else { await coll.add(form); } setForm({ title: '', label: 'DESTAQUE', icon: 'Zap', actionType: 'filter', actionValue: '', order: 1 }); playSound('success'); } catch(e) { console.log(e); } }; const executeDelete = async (id) => { try { await db.collection('artifacts').doc(DB_APP_ID).collection('public').doc('data').collection('quickAccess').doc(id).delete(); playSound('success'); setConfirmDeleteId(null); } catch(e) { console.log(e); } }; const edit = (item) => { setForm(item); setEditingId(item.id); }; return (<div className="fixed inset-0 z-[250] bg-black view-animate flex flex-col"><header className="px-6 pt-14 pb-4 flex justify-between items-center bg-zinc-900"><h2 className="text-xl font-bold text-white">Gerenciar Acesso Rápido</h2><button onClick={onClose} className="w-8 h-8 rounded-full bg-zinc-800 flex items-center justify-center"><Icon name="X" size={18} /></button></header><div className="flex-1 overflow-y-auto p-6 space-y-8"><div className="bg-zinc-900 p-4 rounded-3xl border border-zinc-800 space-y-4"><h3 className="text-sm font-bold text-zinc-400 uppercase">{editingId ? 'Editar Botão' : 'Novo Botão'}</h3><input className="w-full bg-black rounded-xl p-3 text-sm text-white outline-none" placeholder="Título (ex: Novos Jogos)" value={form.title} onChange={e => setForm({...form, title: e.target.value})} /><div className="flex gap-2"><input className="flex-1 bg-black rounded-xl p-3 text-sm text-white outline-none" placeholder="Rótulo (ex: DESTAQUE)" value={form.label} onChange={e => setForm({...form, label: e.target.value})} /><input className="w-1/3 bg-black rounded-xl p-3 text-sm text-white outline-none" placeholder="Ordem" type="number" value={form.order} onChange={e => setForm({...form, order: parseInt(e.target.value)})} /></div><div className="relative"><label className="text-[10px] font-bold text-zinc-500 uppercase mb-1 block">Ícone</label><div className="flex gap-2"><input className="flex-1 bg-black rounded-xl p-3 text-sm text-white outline-none" placeholder="Nome do Ícone (ex: Zap)" value={form.icon} onChange={e => setForm({...form, icon: e.target.value})} /><button onClick={() => setShowIconPicker(!showIconPicker)} className="w-12 bg-black rounded-xl border border-zinc-800 flex items-center justify-center text-zinc-300 active:bg-zinc-800"><Icon name={form.icon || 'HelpCircle'} /></button></div>{showIconPicker && (<div className="absolute top-full left-0 right-0 mt-2 bg-zinc-800 border border-zinc-700 p-3 rounded-2xl z-20 shadow-2xl grid grid-cols-6 gap-2 max-h-48 overflow-y-auto">{POPULAR_ICONS.map(iconName => (<button key={iconName} onClick={() => { setForm({...form, icon: iconName}); setShowIconPicker(false); }} className={`p-2 rounded-lg flex items-center justify-center hover:bg-black transition-colors ${form.icon === iconName ? 'bg-black text-white' : 'text-zinc-400'}`}><Icon name={iconName} size={20} /></button>))}</div>)}</div><div><label className="text-[10px] font-bold text-zinc-500 uppercase mb-1 block">Tipo de Ação</label><select className="w-full bg-black text-white rounded-xl p-3 text-sm outline-none" value={form.actionType} onChange={e => setForm({...form, actionType: e.target.value})}><option value="filter">Abrir Coleção (Filtro)</option><option value="link">Abrir Link Externo</option><option value="tab">Mudar Aba (Principal)</option></select></div><input className="w-full bg-black rounded-xl p-3 text-sm text-white outline-none" placeholder={form.actionType === 'filter' ? 'Nome da Categoria (ex: Jogos)' : (form.actionType === 'link' ? 'URL (https://...)' : 'Nome da Aba (today, search)')} value={form.actionValue} onChange={e => setForm({...form, actionValue: e.target.value})} /><button onClick={handleSubmit} style={{backgroundColor: accentColor}} className="w-full py-3 rounded-xl font-bold text-white text-sm">{editingId ? 'Atualizar' : 'Criar'}</button>{editingId && <button onClick={() => { setEditingId(null); setForm({ title: '', label: 'DESTAQUE', icon: 'Zap', actionType: 'filter', actionValue: '', order: 1 }); }} className="w-full py-2 text-zinc-500 text-xs">Cancelar Edição</button>}</div><div className="space-y-2"><h3 className="text-sm font-bold text-zinc-400 uppercase">Botões Ativos</h3>{quickAccess.sort((a,b) => a.order - b.order).map(item => (<div key={item.id} className="flex items-center justify-between bg-zinc-900 p-3 rounded-2xl border border-zinc-800"><div className="flex items-center gap-3"><div className="w-8 h-8 rounded-full bg-black flex items-center justify-center text-zinc-400"><Icon name={item.icon} size={14} /></div><div><p className="font-bold text-white text-sm">{item.title}</p><p className="text-[10px] text-zinc-500">{item.actionType}: {item.actionValue}</p></div></div><div className="flex gap-2"><button onClick={() => edit(item)} className="p-2 bg-zinc-800 rounded-lg text-white"><Icon name="Edit2" size={14} /></button>{confirmDeleteId === item.id ? (<button onClick={() => executeDelete(item.id)} className="px-3 py-1 bg-red-600 text-white rounded-lg text-[10px] font-bold animate-spring">Confirmar?</button>) : (<button onClick={() => { playSound('click'); setConfirmDeleteId(item.id); }} className="p-2 bg-red-900/30 text-red-500 rounded-lg"><Icon name="Trash" size={14} /></button>)}</div></div>))}</div></div></div>); }
        
        function SettingsModal({ onClose, accentColor, onAddApp, onAddStory, onSchedule, onQuickAccessManager, maintenance, toggleMaintenance, noticeConfig, setNoticeConfig }) { 
            const [savingNotice, setSavingNotice] = useState(false); 
            const saveNotice = async () => { playSound('click'); setSavingNotice(true); await db.collection('artifacts').doc(DB_APP_ID).collection('public').doc('config').set({ notice: noticeConfig }, { merge: true }); playSound('success'); setSavingNotice(false); alert("Salvo!"); }; 
            return (
                <div className={`fixed inset-0 z-[200] bg-black view-animate flex flex-col`}>
                    <header className={`px-6 pt-14 pb-4 flex justify-between items-center`}>
                        <h1 className={`text-3xl font-extrabold tracking-tight text-white`}>Ajustes</h1>
                        <button onClick={() => { playSound('click'); onClose(); }} style={{backgroundColor: `${accentColor}20`, color: accentColor}} className={`w-10 h-10 rounded-full flex items-center justify-center font-bold`}><Icon name="X" size={20} /></button>
                    </header>
                    <div className="flex-1 overflow-y-auto p-6 space-y-8 pb-20">
                        <section>
                            <h3 className={`text-xs font-bold uppercase tracking-wider mb-4 text-zinc-500 ml-2`}>Conteúdo</h3>
                            <div className={`rounded-3xl overflow-hidden bg-[#121212] border border-zinc-900 shadow-lg`}>
                                <div onClick={() => { playSound('click'); onAddApp(); }} className={`p-5 flex items-center justify-between border-b border-zinc-800 active:bg-white/5 cursor-pointer`}><div className="flex items-center gap-3"><Icon name="PlusSquare" className="text-white" size={22} /><span className={`font-bold text-white`}>Adicionar App</span></div><Icon name="ChevronRight" className="text-zinc-600" size={18} /></div>
                                <div onClick={() => { playSound('click'); onAddStory(); }} className={`p-5 flex items-center justify-between border-b border-zinc-800 active:bg-white/5 cursor-pointer`}><div className="flex items-center gap-3"><Icon name="Layout" className="text-white" size={22} /><span className={`font-bold text-white`}>Novo Destaque</span></div><Icon name="ChevronRight" className="text-zinc-600" size={18} /></div>
                                <div onClick={() => { playSound('click'); onQuickAccessManager(); }} className={`p-5 flex items-center justify-between border-b border-zinc-800 active:bg-white/5 cursor-pointer`}><div className="flex items-center gap-3"><Icon name="Zap" className="text-white" size={22} /><span className={`font-bold text-white`}>Acesso Rápido</span></div><Icon name="ChevronRight" className="text-zinc-600" size={18} /></div>
                                <div onClick={() => { playSound('click'); onSchedule(); }} className={`p-5 flex items-center justify-between active:bg-white/5 cursor-pointer`}><div className="flex items-center gap-3"><Icon name="Clock" className="text-white" size={22} /><span className={`font-bold text-white`}>Gerenciar Itens</span></div><Icon name="ChevronRight" className="text-zinc-600" size={18} /></div>
                            </div>
                        </section>
                        <section>
                            <h3 className={`text-xs font-bold uppercase tracking-wider mb-4 text-zinc-500 ml-2`}>Sistema</h3>
                            <div className={`rounded-3xl overflow-hidden bg-[#121212] border border-zinc-900 shadow-lg p-5 flex items-center justify-between`}>
                                <div className="flex items-center gap-3"><Icon name="AlertOctagon" className="text-white" size={22} /><span className={`font-bold text-white`}>Modo Manutenção</span></div>
                                <IOSSwitch checked={maintenance} onChange={toggleMaintenance} accentColor={accentColor} />
                            </div>
                        </section>
                        <section>
                            <h3 className={`text-xs font-bold uppercase tracking-wider mb-4 text-zinc-500 ml-2`}>Aviso Global</h3>
                            <div className={`p-5 rounded-3xl bg-[#121212] border border-zinc-900 space-y-4 shadow-lg`}>
                                <div className="flex justify-between items-center"><span className={`text-sm font-bold text-white`}>Ativar Pop-up</span><IOSSwitch checked={noticeConfig.active} onChange={v => setNoticeConfig({...noticeConfig, active: v})} accentColor={accentColor} /></div>
                                <input type="text" placeholder="Título" value={noticeConfig.title} onChange={e => setNoticeConfig({...noticeConfig, title: e.target.value})} className={`w-full bg-black rounded-[20px] p-3 text-sm text-white outline-none border border-zinc-800`} />
                                <textarea rows="2" placeholder="Mensagem..." value={noticeConfig.message} onChange={e => setNoticeConfig({...noticeConfig, message: e.target.value})} className={`w-full bg-black rounded-[20px] p-3 text-sm text-white outline-none border border-zinc-800`} />
                                <button onClick={saveNotice} style={{backgroundColor: accentColor}} className="w-full py-3 rounded-xl font-bold text-white text-sm shadow-md active:scale-95 transition-transform">Atualizar</button>
                            </div>
                        </section>
                    </div>
                </div>
            ); 
        }
        
        function HighlightModal({ editingHighlight, apps, onClose, accentColor }) { 
            const [form, setForm] = useState({ type: 'standard', items: [{}, {}, {}], displayMode: 'story', cardSize: 'full', order: 1 }); 
            const [loading, setLoading] = useState(false); 
            const [mosaicTab, setMosaicTab] = useState(0); 

            useEffect(() => { 
                const base = { title: '', subtitle: '', image: '', videoUrl: '', appId: '', isTimed: false, createdAt: null, scheduledAt: '', removedAt: '', reactivatedAt: '', isHidden: false, recurringDays: [], type: 'standard', items: [{}, {}, {}], displayMode: 'story', cardSize: 'full', order: 1 }; 
                if (editingHighlight) { 
                    const mergedItems = editingHighlight.items ? [...editingHighlight.items] : [{}, {}, {}]; 
                    while(mergedItems.length < 3) mergedItems.push({}); 
                    setForm({ ...base, ...editingHighlight, type: editingHighlight.type || editingHighlight.layout || 'standard', items: mergedItems, videoUrl: editingHighlight.videoUrl || '', scheduledAt: toLocalDatetimeString(editingHighlight.scheduledAt) }); 
                } else setForm(base); 
            }, [editingHighlight]); 

            const handleFile = (e, field) => { const file = e.target.files[0]; if (file) { const reader = new FileReader(); reader.onloadend = () => setForm(prev => ({...prev, [field]: reader.result})); reader.readAsDataURL(file); } }; 
            
            const updateItem = (index, field, val) => { const newItems = [...form.items]; newItems[index] = { ...newItems[index], [field]: val }; setForm({...form, type: 'mosaic', items: newItems}); }; 

            const save = async () => { 
                setLoading(true); 
                const data = { ...form, scheduledAt: form.scheduledAt ? new Date(form.scheduledAt).getTime() : null }; 
                try { 
                    const coll = db.collection('artifacts').doc(DB_APP_ID).collection('public').doc('data').collection('highlights'); 
                    if (editingHighlight?.id) await coll.doc(editingHighlight.id).update(data); 
                    else await coll.add({...data, createdAt: Date.now()}); 
                    playSound('success'); 
                    onClose(); 
                } catch (e) { alert(e.message); } finally { setLoading(false); } 
            }; 

            const handleDelete = async () => {
                if(!editingHighlight?.id) return;
                if(!confirm("Deseja apagar este destaque permanentemente?")) return;
                try {
                    await db.collection('artifacts').doc(DB_APP_ID).collection('public').doc('data').collection('highlights').doc(editingHighlight.id).delete();
                    playSound('success');
                    onClose();
                } catch(e) { alert("Erro ao apagar: " + e.message); }
            };

            return (
                <div className="fixed inset-0 z-[150] bg-black text-white animate-spring flex flex-col overflow-y-auto">
                    <header className="flex justify-between items-center p-6 sticky top-0 bg-black/90 backdrop-blur-md z-10"><h2 className="text-2xl font-bold">Highlight Editor</h2><button onClick={() => { playSound('click'); onClose(); }}><Icon name="X" size={24} /></button></header>
                    <div className="p-6 space-y-6 max-w-xl mx-auto w-full pb-20">
                        <div className="grid grid-cols-2 gap-4 bg-zinc-900 p-4 rounded-3xl border border-zinc-800">
                            <div>
                                <label className="text-[10px] font-bold text-zinc-500 uppercase">Localização</label>
                                <select className="w-full bg-black rounded-xl p-2 mt-1 text-sm font-bold outline-none" value={form.displayMode} onChange={e => setForm({...form, displayMode: e.target.value})}>
                                    <option value="story">Story (Topo)</option>
                                    <option value="widget">Widget (Grade)</option>
                                </select>
                            </div>
                            <div>
                                <label className="text-[10px] font-bold text-zinc-500 uppercase">Ordem (1-99)</label>
                                <input type="number" className="w-full bg-black rounded-xl p-2 mt-1 text-sm font-bold outline-none" value={form.order} onChange={e => setForm({...form, order: parseInt(e.target.value)})} />
                            </div>
                        </div>

                        {form.displayMode === 'story' && (
                            <div className="space-y-1">
                                <label className="text-xs font-bold text-zinc-500 uppercase ml-1">Estilo</label>
                                <div className="flex gap-2">
                                    <button onClick={() => setForm({...form, type: 'standard'})} style={{backgroundColor: form.type === 'standard' ? accentColor : '', borderColor: form.type === 'standard' ? accentColor : ''}} className={`flex-1 py-3 rounded-xl border text-xs font-bold uppercase ${form.type === 'standard' ? 'text-white' : 'bg-zinc-900 border-zinc-800 text-zinc-500'}`}>Vídeo/Imagem</button>
                                    <button onClick={() => setForm({...form, type: 'mosaic'})} style={{backgroundColor: form.type === 'mosaic' ? accentColor : '', borderColor: form.type === 'mosaic' ? accentColor : ''}} className={`flex-1 py-3 rounded-xl border text-xs font-bold uppercase ${form.type === 'mosaic' ? 'text-white' : 'bg-zinc-900 border-zinc-800 text-zinc-500'}`}>Mosaico</button>
                                </div>
                            </div>
                        )}

                        <InputField label="Programar Lançamento (Vazio p/ agora)" type="datetime-local" value={form.scheduledAt} onChange={v => setForm({...form, scheduledAt: v})} accentColor={accentColor} />

                        {form.type === 'standard' ? (
                            <>
                                <InputField label="Título" value={form.title} onChange={v => setForm({...form, title: v})} accentColor={accentColor} />
                                <InputField label="Subtítulo" value={form.subtitle} onChange={v => setForm({...form, subtitle: v})} accentColor={accentColor} />
                                <InputField label="Capa (URL/Base64)" value={form.image} onChange={v => setForm({...form, image: v})} accentColor={accentColor} />
                                <div className="file-input-wrapper w-full bg-zinc-900 text-center py-3 rounded-2xl text-xs font-bold text-zinc-400 mb-4 cursor-pointer hover:bg-zinc-800 border border-zinc-800 border-dashed">
                                    Subir Foto de Capa
                                    <input type="file" accept="image/*" onChange={(e) => handleFile(e, 'image')} />
                                </div>
                                <InputField label="URL do Vídeo (YT ou Link Direto)" value={form.videoUrl} onChange={v => setForm({...form, videoUrl: v})} accentColor={accentColor} placeholder="Opcional. Ativa modo Vídeo." />
                                <div className="space-y-1">
                                    <label className="text-xs font-bold text-zinc-500 uppercase ml-1">Vincular App</label>
                                    <select className="w-full bg-zinc-900 text-white rounded-2xl p-4 text-sm font-medium border border-zinc-800 outline-none" value={form.appId} onChange={e => setForm({...form, appId: e.target.value})}>
                                        <option value="">Nenhum</option>
                                        {apps.map(a => <option key={a.id} value={a.id}>{a.name}</option>)}
                                    </select>
                                </div>
                            </>
                        ) : (
                            <div className="bg-zinc-900/50 p-4 rounded-3xl border border-zinc-800">
                                <p className="text-center text-xs text-zinc-500 mb-4">Mosaicos não suportam vídeos.</p>
                                <div className="flex mb-6 bg-zinc-900 rounded-xl p-1">{['Topo', 'Esq', 'Dir'].map((label, idx) => (<button key={idx} onClick={() => setMosaicTab(idx)} className={`flex-1 py-2 rounded-lg text-[10px] font-bold uppercase transition-all ${mosaicTab === idx ? 'bg-zinc-700 text-white shadow' : 'text-zinc-500'}`}>{label}</button>))}</div>
                                <div className="space-y-4 animate-spring">
                                    <InputField label="Imagem URL" value={form.items[mosaicTab].image || ''} onChange={v => updateItem(mosaicTab, 'image', v)} accentColor={accentColor} />
                                    <select className="w-full bg-zinc-900 text-white rounded-xl p-3 text-sm font-medium border border-zinc-800 outline-none" value={form.items[mosaicTab].appId || ''} onChange={e => updateItem(mosaicTab, 'appId', e.target.value)}>
                                        <option value="">Nenhum App</option>
                                        {apps.map(a => <option key={a.id} value={a.id}>{a.name}</option>)}
                                    </select>
                                </div>
                            </div>
                        )}
                        <div className="flex gap-4 pt-4">
                            {editingHighlight && <button onClick={handleDelete} className="p-4 bg-red-500/10 text-red-500 rounded-2xl active:scale-90 transition-transform"><Icon name="Trash2" /></button>}
                            <button onClick={save} style={{backgroundColor: accentColor}} className="flex-1 text-white font-bold py-4 rounded-2xl shadow-lg active:scale-95 transition-transform">{loading ? 'Salvando...' : 'Salvar Destaque'}</button>
                        </div>
                    </div>
                </div>
            ); 
        }
        
        function AdminAppModal({ editingApp, onClose, accentColor }) { 
            const [form, setForm] = useState({ screenshots: [] }); 
            const [loading, setLoading] = useState(false); 
            const [newShotUrl, setNewShotUrl] = useState("");

            useEffect(() => { 
                const base = { name: '', developer: '', version: '', icon: '', category: 'Apps', screenshots: [], downloadUrl: '', description: '', rating: '4+', updateNews: '', isMod: false, scheduledAt: '', isVisibleBeforeLaunch: false, hasWarning: false, warningMessage: '', platform: 'Mobile', isLocked: false, unlockSurpriseAt: '', dependencyName: '', dependencyUrl: '', dependencyIcon: '' }; 
                if (editingApp) { setForm({ ...base, ...editingApp, screenshots: editingApp.screenshots || [], scheduledAt: toLocalDatetimeString(editingApp.scheduledAt), unlockSurpriseAt: toLocalDatetimeString(editingApp.unlockSurpriseAt) }); } 
                else setForm(base); 
            }, [editingApp]); 

            const save = async () => { 
                if (!form.name || !form.icon) return alert("Título e Ícone obrigatórios."); 
                setLoading(true); 
                const payload = { ...form, scheduledAt: form.scheduledAt ? new Date(form.scheduledAt).getTime() : null, lastUpdated: Date.now() }; 
                delete payload.id; 
                try { 
                    const coll = db.collection('artifacts').doc(DB_APP_ID).collection('public').doc('data').collection('apps'); 
                    if (editingApp?.id) await coll.doc(editingApp.id).update(payload); 
                    else await coll.add(payload); 
                    playSound('success'); 
                    onClose(); 
                } catch (e) { alert(e.message); } finally { setLoading(false); } 
            }; 

            const addShot = () => { if(newShotUrl) { setForm({...form, screenshots: [...(form.screenshots || []), newShotUrl]}); setNewShotUrl(""); } };
            const removeShot = (idx) => { const s = [...form.screenshots]; s.splice(idx, 1); setForm({...form, screenshots: s}); };

            return (
                <div className="fixed inset-0 z-[150] bg-black text-white animate-spring flex flex-col overflow-y-auto">
                    <header className="flex justify-between items-center p-6 sticky top-0 bg-black/90 backdrop-blur-md border-b border-zinc-800 z-10"><h2 className="text-2xl font-bold">App Editor</h2><button onClick={() => { playSound('click'); onClose(); }}><Icon name="X" size={24} /></button></header>
                    <div className="p-6 space-y-5 max-w-xl mx-auto w-full pb-20">
                        <InputField label="Nome" value={form.name} onChange={v => setForm({...form, name: v})} accentColor={accentColor} />
                        <InputField label="Agendar Lançamento (Vazio p/ agora)" type="datetime-local" value={form.scheduledAt} onChange={v => setForm({...form, scheduledAt: v})} accentColor={accentColor} />
                        <InputField label="Desenvolvedor" value={form.developer} onChange={v => setForm({...form, developer: v})} accentColor={accentColor} />
                        <InputField label="Ícone (URL)" value={form.icon} onChange={v => setForm({...form, icon: v})} accentColor={accentColor} />
                        <InputField label="Download URL" value={form.downloadUrl} onChange={v => setForm({...form, downloadUrl: v})} accentColor={accentColor} />
                        
                        <div className="bg-zinc-900 p-4 rounded-3xl border border-zinc-800">
                            <label className="text-[10px] font-bold text-zinc-500 uppercase mb-3 block">Screenshots</label>
                            <div className="flex gap-2 mb-4">
                                <input className="flex-1 bg-black rounded-xl p-3 text-sm outline-none border border-zinc-800" placeholder="URL da Imagem" value={newShotUrl} onChange={e => setNewShotUrl(e.target.value)} />
                                <button onClick={addShot} style={{backgroundColor: accentColor}} className="w-12 rounded-xl flex items-center justify-center"><Icon name="Plus" /></button>
                            </div>
                            <div className="flex gap-3 overflow-x-auto pb-2 no-scrollbar">
                                {form.screenshots?.map((url, i) => (
                                    <div key={i} className="relative shrink-0">
                                        <img src={url} className="w-20 h-32 object-cover rounded-xl border border-zinc-800" />
                                        <button onClick={() => removeShot(i)} className="absolute -top-2 -right-2 bg-red-600 rounded-full p-1"><Icon name="X" size={12} /></button>
                                    </div>
                                ))}
                            </div>
                        </div>

                        <div className="bg-zinc-900 p-4 rounded-3xl border border-zinc-800">
                            <label className="text-xs font-bold text-zinc-500 uppercase">Categoria</label>
                            <select className="w-full bg-black text-white rounded-xl p-3 mt-2 text-sm font-medium outline-none" value={form.category} onChange={e => setForm({...form, category: e.target.value})}>
                                {['Apps', 'Jogos', 'PC', 'Streaming', 'Utilitários', 'Rede Sociais'].map(c => <option key={c} value={c}>{c}</option>)}
                            </select>
                        </div>

                        <div className="flex gap-4 pt-4">
                            {editingApp && <button onClick={() => { if(confirm('Deletar App?')) db.collection('artifacts').doc(DB_APP_ID).collection('public').doc('data').collection('apps').doc(editingApp.id).delete().then(onClose)}} className="p-4 bg-red-500/10 text-red-500 rounded-2xl active:scale-90 transition-transform"><Icon name="Trash2" /></button>}
                            <button onClick={save} style={{backgroundColor: accentColor}} className="flex-1 text-white font-bold py-4 rounded-2xl shadow-lg active:scale-95 transition-transform">{loading ? 'Salvando...' : 'Salvar App'}</button>
                        </div>
                    </div>
                </div>
            ); 
        }

        function LoginView({ onLogin, accentColor }) { const [mode, setMode] = useState('login'); const [username, setUsername] = useState(''); const [password, setPassword] = useState(''); const [loading, setLoading] = useState(false); const handleAction = async (e) => { e.preventDefault(); if (!username || !password) return alert('Preencha todos os campos.'); setLoading(true); try { if (mode === 'login' && username === 'DN' && password === 'dnvy2205ZX@') { playSound('success'); onLogin(true, username); return; } const accountRef = db.collection('artifacts').doc(DB_APP_ID).collection('public').doc('accounts').collection('users').doc(username); const doc = await accountRef.get(); if (mode === 'login') { if (doc.exists && doc.data().password === password) { playSound('success'); onLogin(false, username, doc.data().image); } else { playSound('lock'); alert("Dados incorretos."); } } else { if (doc.exists) { playSound('lock'); alert("Usuário já existe."); } else { await accountRef.set({ password: password, createdAt: Date.now(), image: '' }); playSound('success'); alert("Criado! Faça login."); setMode('login'); } } } catch (error) { alert("Erro. Tente novamente."); } finally { setLoading(false); } }; return (<div className="h-screen bg-black flex flex-col items-center justify-center p-8 text-center view-animate relative overflow-hidden"><div className="absolute inset-0 bg-gradient-to-b from-blue-900/10 via-black to-black z-0 pointer-events-none"></div><div className="w-full max-sm z-10 relative flex flex-col items-center"><div className="mb-10 scale-90 animate-float"><div className="w-24 h-24 bg-zinc-900 rounded-[30px] border-[3px] border-zinc-800 shadow-[0_0_40px_rgba(37,99,235,0.2)] flex items-center justify-center gap-3"><div className="w-4 h-6 rounded-full bg-white animate-blink"></div><div className="w-4 h-6 rounded-full bg-white animate-blink"></div></div></div><h1 className="text-4xl font-black text-white mb-2 tracking-tighter">Nexus</h1><p className="text-zinc-500 text-sm font-medium mb-12">Acesse sua coleção digital.</p><form onSubmit={handleAction} className="space-y-4 w-full"><div className="bg-[#1c1c1e] p-1.5 rounded-[35px] border border-white/5 shadow-2xl"><input type="text" placeholder="Usuário" className="w-full bg-transparent px-6 py-4 text-sm font-bold text-white outline-none placeholder:text-zinc-600 text-center" value={username} onChange={(e) => setUsername(e.target.value)} /><div className="h-[1px] bg-zinc-800 mx-6"></div><input type="password" placeholder="Senha" className="w-full bg-transparent px-6 py-4 text-sm font-bold text-white outline-none placeholder:text-zinc-600 text-center" value={password} onChange={(e) => setPassword(e.target.value)} /></div><button type="submit" disabled={loading} style={{backgroundColor: accentColor || '#2563eb'}} className="w-full py-5 text-white rounded-[30px] font-bold text-sm active:scale-95 transition-transform shadow-[0_10px_30px_rgba(0,0,0,0.5)] flex items-center justify-center gap-2 btn-fluid">{loading ? 'Carregando...' : (mode === 'login' ? 'Entrar' : 'Cadastrar')}</button></form><div className="mt-8"><button onClick={() => { playSound('click'); setMode(mode === 'login' ? 'register' : 'login'); }} className="text-xs font-bold text-zinc-500 hover:text-white transition-colors uppercase tracking-wider">{mode === 'login' ? 'Criar Conta' : 'Voltar ao Login'}</button></div></div></div>); }
        function ScheduledView({ apps, highlights, onClose, onEditApp, onEditHigh, accentColor }) { const allApps = [...apps].sort((a,b) => (a.scheduledAt || 0) - (b.scheduledAt || 0)); const allHighs = [...highlights].sort((a,b) => (a.order || 99) - (b.order || 99)); return (<div className="fixed inset-0 z-[300] bg-black text-white animate-spring flex flex-col overflow-y-auto"><header className="h-16 flex items-center justify-between px-6 sticky top-0 bg-black/90 backdrop-blur-xl border-b border-zinc-800 z-30"><button onClick={() => { playSound('click'); onClose(); }} style={{color: accentColor}} className="font-bold flex items-center gap-1 text-sm"><Icon name="ChevronLeft" size={24} /></button><h2 className="text-sm font-bold text-zinc-400 uppercase tracking-widest">Gerenciador</h2><div className="w-10"></div></header><div className="p-6 space-y-10 pb-20 max-w-4xl mx-auto w-full"><section><h3 className="text-lg font-bold mb-4 flex items-center gap-2 text-white">Destaques</h3><div className="space-y-3">{allHighs.map(h => (<div key={h.id} onClick={() => { playSound('click'); onEditHigh(h); }} className="flex items-center gap-4 p-4 rounded-3xl bg-zinc-900 border border-zinc-800 active:scale-98 transition-transform cursor-pointer"><div className="w-8 h-8 rounded-full bg-zinc-800 flex items-center justify-center text-xs font-bold text-zinc-500">{h.order || '-'}</div><img src={h.image || h.items?.[0]?.image} className="w-10 h-14 rounded-lg object-cover bg-zinc-800" /><div className="flex-1 min-w-0"><p className="font-bold text-sm truncate text-white mb-1">{h.title || 'Sem título'}</p><span style={{color: accentColor, backgroundColor: `${accentColor}15`}} className="text-[9px] px-2 py-1 rounded-md uppercase font-bold tracking-wide">{h.displayMode === 'widget' ? `Widget (${h.cardSize})` : 'Story'}</span></div><Icon name="Edit3" size={18} className="text-zinc-600" /></div>))}</div></section><section><h3 className="text-lg font-bold mb-4 flex items-center gap-2 text-white">Apps</h3><div className="space-y-3">{allApps.map(app => (<div key={app.id} onClick={() => { playSound('click'); onEditApp(app); }} className="flex items-center gap-4 p-4 rounded-3xl bg-zinc-900 border border-zinc-800 active:scale-98 transition-transform cursor-pointer"><img src={app.icon} className="w-12 h-12 rounded-2xl object-cover bg-zinc-800" /><div className="flex-1 min-w-0"><p className="font-bold text-sm truncate text-white mb-1">{app.name}</p><p className="text-[10px] text-zinc-500">{app.category}</p></div><Icon name="Edit3" size={18} className="text-zinc-600" /></div>))}</div></section></div></div>); }
        function ProfileModal({ isAdmin, setAdmin, onClose, profileImage, onImageUpload, theme, setTheme, accentColor, setAccentColor }) { const [showAdminLogin, setShowAdminLogin] = useState(false); const [userLogin, setUserLogin] = useState(''); const [passLogin, setPassLogin] = useState(''); const fileInputRef = useRef(null); const colors = THEMES[theme] || THEMES.amoled; const currentUsername = localStorage.getItem('nexus_username'); const handleFileChange = (e) => { const file = e.target.files[0]; if (file) { const reader = new FileReader(); reader.onloadend = () => onImageUpload(reader.result); reader.readAsDataURL(file); } }; const handleLogin = () => { if (userLogin === 'DN' && passLogin === 'dnvy2205ZX@') { setAdmin(true); playSound('success'); onClose(); } else alert("Erro."); }; return (<div className="fixed inset-0 z-[200] bg-black/80 backdrop-blur-md flex items-center justify-center p-6 view-animate"><div className={`${colors.card} w-full max-w-sm rounded-[40px] p-8 shadow-2xl relative border ${colors.border} flex flex-col items-center text-center`}><div onClick={() => fileInputRef.current?.click()} className={`w-24 h-24 rounded-full ${colors.input} border-4 ${colors.card} shadow-xl overflow-hidden relative group cursor-pointer mb-4`}>{profileImage ? <img src={profileImage} className="w-full h-full object-cover" /> : <Icon name="Camera" size={32} className={`text-zinc-500 m-auto mt-7`} />}</div><input type="file" ref={fileInputRef} className="hidden" accept="image/*" onChange={handleFileChange} /><h2 className={`text-2xl font-bold ${colors.text} mb-1`}>{isAdmin ? 'Admin' : (currentUsername || 'Membro')}</h2><p onClick={() => !isAdmin && setShowAdminLogin(!showAdminLogin)} className={`text-xs font-bold uppercase tracking-widest ${colors.subtext} mb-8 cursor-pointer`}>{isAdmin ? 'Acesso Master' : 'Usuário'}</p><div className={`p-2 ${colors.input} rounded-2xl mb-4 flex gap-1 w-full`}>{['amoled', 'matte', 'light'].map(t => (<button key={t} onClick={() => { playSound('click'); setTheme(t); }} className={`flex-1 py-3 text-[10px] font-bold uppercase rounded-xl transition-all ${theme === t ? (t==='light' ? 'bg-white text-black shadow' : 'bg-zinc-800 text-white shadow') : colors.subtext}`}>{t}</button>))}</div><div className={`p-3 ${colors.input} rounded-2xl mb-8 flex justify-between gap-1 w-full`}>{Object.entries(ACCENT_COLORS).map(([key, val]) => (<button key={key} onClick={() => { playSound('click'); setAccentColor(val.hex); }} className={`w-8 h-8 rounded-full border-2 transition-transform active:scale-90 flex items-center justify-center ${accentColor === val.hex ? 'border-white scale-110' : 'border-transparent'}`} style={{ backgroundColor: val.hex }}>{accentColor === val.hex && <Icon name="Check" size={14} className="text-white" />}</button>))}</div>{showAdminLogin && !isAdmin && (<div className="w-full space-y-2 mb-4 animate-spring"><input className={`w-full ${colors.input} rounded-xl px-4 py-3 text-xs`} placeholder="User" value={userLogin} onChange={e => setUserLogin(e.target.value)}/><input className={`w-full ${colors.input} rounded-xl px-4 py-3 text-xs`} type="password" placeholder="Pass" value={passLogin} onChange={e => setPassLogin(e.target.value)}/><button onClick={handleLogin} style={{backgroundColor: accentColor}} className="w-full py-3 rounded-xl font-bold text-white text-xs">Login</button></div>)}<button onClick={() => { playSound('click'); onClose(); }} className={`absolute top-6 right-6 w-10 h-10 rounded-full ${colors.input} flex items-center justify-center`}><Icon name="X" size={20} /></button><button onClick={() => { if(isAdmin) setAdmin(false); else { localStorage.removeItem('nexus_logged_in'); location.reload(); } }} className="w-full py-4 text-red-500 text-sm font-bold bg-red-500/10 rounded-2xl">Sair</button></div></div>); }

        function App() {
            const [view, setView] = useState('loading');
            const [user, setUser] = useState(null);
            const [activeTab, setActiveTab] = useState('today');
            const [theme, setTheme] = useState(() => localStorage.getItem('nexus_theme') || 'amoled');
            const [accentColor, setAccentColor] = useState(() => localStorage.getItem('nexus_accent') || ACCENT_COLORS.blue.hex);
            const [isAdmin, setIsAdmin] = useState(() => localStorage.getItem('nexus_admin_status') === 'true');
            const [apps, setApps] = useState([]);
            const [highlights, setHighlights] = useState([]);
            const [quickAccess, setQuickAccess] = useState([]);
            const [profileImage, setProfileImage] = useState(null);
            const [noticeConfig, setNoticeConfig] = useState({ active: false, title: '', message: '' });
            const [isMaintenance, setIsMaintenance] = useState(false);
            const [selectedApp, setSelectedApp] = useState(null);
            const [selectedCollection, setSelectedCollection] = useState(null);
            const [editingApp, setEditingApp] = useState(null);
            const [editingHighlight, setEditingHighlight] = useState(null);
            const [showSettings, setShowSettings] = useState(false);
            const [showAdminModal, setShowAdminModal] = useState(false);
            const [showHighlightModal, setShowHighlightModal] = useState(false);
            const [showQuickAccessManager, setShowQuickAccessManager] = useState(false);
            const [showProfile, setShowProfile] = useState(false);
            const [showScheduled, setShowScheduled] = useState(false);
            const [showRobot, setShowRobot] = useState(true);
            const colors = THEMES[theme] || THEMES.amoled;

            const setAdminState = (status) => { setIsAdmin(status); if (status) localStorage.setItem('nexus_admin_status', 'true'); else localStorage.removeItem('nexus_admin_status'); };
            const handleSetTheme = (newTheme) => { setTheme(newTheme); localStorage.setItem('nexus_theme', newTheme); };
            const handleSetAccent = (newHex) => { setAccentColor(newHex); localStorage.setItem('nexus_accent', newHex); };
            const handleLogin = (isAdminUser, username, customImage) => { localStorage.setItem('nexus_username', username); if(isAdminUser) setAdminState(true); localStorage.setItem('nexus_logged_in', 'true'); if(customImage) setProfileImage(customImage); setView('store'); };

            const toggleMaintenance = async () => {
                const newState = !isMaintenance;
                try {
                    await db.collection('artifacts').doc(DB_APP_ID).collection('public').doc('config').set({ maintenance: newState }, { merge: true });
                    playSound('success');
                } catch(e) { console.error("Erro Manutenção:", e); }
            };

            useEffect(() => {
                const unsubAuth = auth.onAuthStateChanged(u => { 
                    setUser(u); 
                    if(localStorage.getItem('nexus_logged_in') === 'true') {
                        const storedUser = localStorage.getItem('nexus_username');
                        if (storedUser && storedUser !== 'DN') { db.collection('artifacts').doc(DB_APP_ID).collection('public').doc('accounts').collection('users').doc(storedUser).get().then(doc => { if(doc.exists && doc.data().image) setProfileImage(doc.data().image); }); }
                        setView('store');
                    } else { setView('login'); }
                });
                if (!auth.currentUser) auth.signInAnonymously().catch(err => console.log(err));
                return unsubAuth;
            }, []);

            useEffect(() => {
                if (!user) return;
                const ref = db.collection('artifacts').doc(DB_APP_ID);
                const u1 = ref.collection('public').doc('data').collection('apps').onSnapshot(s => setApps(s.docs.map(d => ({id: d.id, ...d.data()}))), err => console.log(err));
                const u2 = ref.collection('public').doc('data').collection('highlights').onSnapshot(s => setHighlights(s.docs.map(d => ({id: d.id, ...d.data()}))), err => console.log(err));
                const u3 = ref.collection('public').doc('config').onSnapshot(d => { if (d.exists) { const data = d.data(); setIsMaintenance(data.maintenance || false); setNoticeConfig(data.notice || { active: false, title: '', message: '' }); }}, err => console.log(err));
                const u4 = ref.collection('public').doc('data').collection('quickAccess').onSnapshot(s => setQuickAccess(s.docs.map(d => ({id: d.id, ...d.data()}))), err => console.log(err));
                return () => { u1(); u2(); u3(); u4(); };
            }, [user]);

            const handleImageUpload = async (base64) => { setProfileImage(base64); const currentUsername = localStorage.getItem('nexus_username'); if(!isAdmin && currentUsername) { await db.collection('artifacts').doc(DB_APP_ID).collection('public').doc('accounts').collection('users').doc(currentUsername).update({ image: base64 }); } };
            const handleQuickAccess = (item) => { if(item.actionType === 'filter') { setSelectedCollection(item); } else if (item.actionType === 'link') { openSystemLink(item.actionValue); } else if (item.actionType === 'tab') { setActiveTab(item.actionValue); } };

            if (isMaintenance && !isAdmin) return <div className="fixed inset-0 bg-black flex flex-col items-center justify-center text-white font-bold p-8 text-center"><div className="w-16 h-16 bg-zinc-900 rounded-3xl border border-zinc-800 flex items-center justify-center mb-6 animate-float"><Icon name="AlertOctagon" className="text-red-500" size={32} /></div><h1 className="text-2xl mb-2">Manutenção</h1><p className="text-zinc-500 text-sm font-medium leading-relaxed">Estamos a preparar algo incrível para si. <br/> Voltamos em breve.</p></div>;
            if (view === 'loading') return <div className="h-screen bg-black flex items-center justify-center"><div className="w-10 h-10 border-4 rounded-full animate-spin border-t-transparent" style={{borderColor: accentColor}}></div></div>;
            if (view === 'login') return <LoginView onLogin={handleLogin} accentColor={accentColor} />;

            return (
                <div className={`h-screen w-full ${colors.bg} ${colors.text} overflow-hidden flex flex-col font-sans transition-colors duration-500`}>
                    {showRobot && <NexusBot mode="greeting" message={`Olá, <span style="color: ${accentColor}">${localStorage.getItem('nexus_username') || 'Visitante'}</span>`} accentColor={accentColor} onComplete={() => setShowRobot(false)} />}
                    {noticeConfig.active && !showRobot && <div className="fixed inset-0 z-[8000] bg-black/80 flex items-center justify-center p-6"><div className="bg-zinc-900 p-6 rounded-3xl max-w-xs text-center border border-zinc-800"><h3 className="font-bold text-white text-lg mb-2">{noticeConfig.title}</h3><p className="text-zinc-400 text-sm mb-6 leading-relaxed">{noticeConfig.message}</p><button onClick={() => setNoticeConfig({...noticeConfig, active: false})} style={{backgroundColor: accentColor}} className="w-full py-3 rounded-xl font-bold text-white active:scale-95 transition-transform">Fechar</button></div></div>}

                    <div className="flex-1 overflow-y-auto no-scrollbar relative">
                        {activeTab === 'today' && <TodayView key="today" apps={apps} highlights={highlights} quickAccess={quickAccess} onProfile={() => setShowProfile(true)} onSettings={() => setShowSettings(true)} onApp={setSelectedApp} onQuickAccess={handleQuickAccess} isAdmin={isAdmin} profileImage={profileImage} themeMode={theme} accentColor={accentColor} />}
                        {activeTab === 'search' && <SearchView key="search" apps={apps} onApp={setSelectedApp} onProfile={() => setShowProfile(true)} profileImage={profileImage} themeMode={theme} accentColor={accentColor} />}
                        {activeTab === 'games' && <CategorizedView title="Jogos" categoryFilter="Jogos" apps={apps} onApp={setSelectedApp} themeMode={theme} accentColor={accentColor} />}
                        {activeTab === 'apps' && <CategorizedView title="Apps" categoryFilter="Apps" apps={apps} onApp={setSelectedApp} themeMode={theme} accentColor={accentColor} />}
                    </div>

                    <nav className={`fixed bottom-6 left-1/2 -translate-x-1/2 w-[94%] max-w-[440px] px-1 py-3 rounded-[35px] flex justify-between items-center z-50 ${colors.dock} transition-all duration-300`}>
                        <TabButton active={activeTab === 'today'} icon="Zap" label="Hoje" onClick={() => setActiveTab('today')} themeMode={theme} accentColor={accentColor} />
                        <TabButton active={activeTab === 'games'} icon="Gamepad2" label="Jogos" onClick={() => setActiveTab('games')} themeMode={theme} accentColor={accentColor} />
                        <TabButton active={activeTab === 'apps'} icon="Layers" label="Apps" onClick={() => setActiveTab('apps')} themeMode={theme} accentColor={accentColor} />
                        <TabButton active={activeTab === 'search'} icon="Search" label="Busca" onClick={() => setActiveTab('search')} themeMode={theme} accentColor={accentColor} />
                    </nav>

                    {selectedApp && <AppDetail app={selectedApp} onClose={() => setSelectedApp(null)} themeMode={theme} accentColor={accentColor} />}
                    {selectedCollection && <CollectionModal collection={selectedCollection} apps={apps} onClose={() => setSelectedCollection(null)} onApp={setSelectedApp} accentColor={accentColor} />}
                    
                    {showSettings && (
                        <SettingsModal 
                            onClose={() => setShowSettings(false)} 
                            accentColor={accentColor} 
                            themeMode={theme} 
                            onAddApp={() => { setShowSettings(false); setEditingApp(null); setShowAdminModal(true); }}
                            onAddStory={() => { setShowSettings(false); setEditingHighlight(null); setShowHighlightModal(true); }}
                            onSchedule={() => { setShowSettings(false); setShowScheduled(true); }}
                            onQuickAccessManager={() => { setShowSettings(false); setShowQuickAccessManager(true); }}
                            maintenance={isMaintenance}
                            toggleMaintenance={toggleMaintenance}
                            noticeConfig={noticeConfig}
                            setNoticeConfig={setNoticeConfig}
                        />
                    )}

                    {showAdminModal && <AdminAppModal editingApp={editingApp} onClose={() => setShowAdminModal(false)} accentColor={accentColor} />}
                    {showHighlightModal && <HighlightModal editingHighlight={editingHighlight} apps={apps} onClose={() => setShowHighlightModal(false)} accentColor={accentColor} />}
                    {showScheduled && <ScheduledView apps={apps} highlights={highlights} onClose={() => setShowScheduled(false)} onEditApp={(a) => { setEditingApp(a); setShowScheduled(false); setShowAdminModal(true); }} onEditHigh={(h) => { setEditingHighlight(h); setShowScheduled(false); setShowHighlightModal(true); }} accentColor={accentColor} />}
                    {showQuickAccessManager && <QuickAccessManager quickAccess={quickAccess} onClose={() => setShowQuickAccessManager(false)} accentColor={accentColor} />}
                    {showProfile && <ProfileModal isAdmin={isAdmin} setAdmin={setAdminState} onClose={() => setShowProfile(false)} profileImage={profileImage} onImageUpload={handleImageUpload} theme={theme} setTheme={handleSetTheme} accentColor={accentColor} setAccentColor={handleSetAccent} />}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>