<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Nexus Store 5.0</title>
    
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Nexus">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/4712/4712109.png">
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/4712/4712109.png">

    <!-- Dependências -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
        
        body { 
            font-family: 'Plus Jakarta Sans', -apple-system, sans-serif; 
            margin: 0; 
            background-color: #050505; 
            color: white;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            overflow: hidden;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Novas Animações Fluidas (Spring Physics) */
        @keyframes springUp { 
            0% { transform: translateY(100px) scale(0.9); opacity: 0; } 
            60% { transform: translateY(-10px) scale(1.02); opacity: 1; }
            100% { transform: translateY(0) scale(1); opacity: 1; }
        }
        
        @keyframes springScale { 
            0% { transform: scale(0.5); opacity: 0; } 
            60% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }

        @keyframes floatSmooth { 
            0%, 100% { transform: translateY(0px); } 
            50% { transform: translateY(-8px); } 
        }

        @keyframes pulseGlow {
            0%, 100% { box-shadow: 0 0 20px -5px currentColor; }
            50% { box-shadow: 0 0 35px -5px currentColor; }
        }

        .animate-spring-up { animation: springUp 0.8s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
        .animate-spring-scale { animation: springScale 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
        .animate-float-smooth { animation: floatSmooth 4s ease-in-out infinite; }
        
        /* Utilitários de Profundidade */
        .glass-panel {
            background: rgba(30, 30, 30, 0.6);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
        }

        .depth-card {
            box-shadow: 0 10px 40px -10px rgba(0,0,0,0.5), inset 0 1px 0 rgba(255,255,255,0.1);
        }

        .input-round { border-radius: 99px; }
        
        .btn-press { transition: transform 0.1s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .btn-press:active { transform: scale(0.92); }

        .app-icon { 
            mask-image: url("data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNMTAwIDBDNDQuNzcyIDAgMCA0NC43NzIgMCAxMDBzNDQuNzcyIDEwMCAxMDAgMTAwIDEwMC00NC43NzIgMTAwLTEwMFMxNTUuMjI4IDAgMTAwIDB6IiBmaWxsPSJibGFjayIvPjwvc3ZnPg==");
            -webkit-mask-image:  radial-gradient(white, black);
            border-radius: 24px; /* Fallback */
            border-radius: 22%; /* Squircle ish */
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        const APP_VERSION = "5.0.0"; 

        const firebaseConfig = {
            apiKey: "AIzaSyDcWSyP6S7LDuGQ1ZjFqKAHCZ8mjwJhEKY",
            authDomain: "nexus-hub-159db.firebaseapp.com",
            projectId: "nexus-hub-159db",
            storageBucket: "nexus-hub-159db.firebasestorage.app",
            messagingSenderId: "400199878551",
            appId: "1:400199878551:web:4f58353584daffbeb026d2"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const DB_APP_ID = 'nexus-hub-permanent-vault';

        // --- SISTEMA DE ÁUDIO (SFX APENAS) ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const initAudio = () => { if (audioCtx.state === 'suspended') audioCtx.resume(); };
        window.addEventListener('click', initAudio, { once: true });
        window.addEventListener('touchstart', initAudio, { once: true });

        const playTone = (freq, type, duration, vol = 0.1) => {
            try {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.type = type;
                osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
                gain.gain.setValueAtTime(vol, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.start();
                osc.stop(audioCtx.currentTime + duration);
            } catch(e) {}
        };

        const playSound = (name) => {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            switch (name) {
                case 'click': playTone(600, 'sine', 0.1, 0.2); break;
                case 'open': playTone(400, 'sine', 0.2, 0.2); playTone(800, 'sine', 0.3, 0.1); break;
                case 'success': playTone(500, 'sine', 0.1, 0.2); setTimeout(() => playTone(800, 'sine', 0.2, 0.2), 100); break;
                case 'lock': playTone(150, 'square', 0.2, 0.1); break;
                case 'pop': playTone(700, 'triangle', 0.05, 0.15); break;
            }
        };

        const THEMES = {
            amoled: { bg: 'bg-[#000000]', text: 'text-white', card: 'bg-[#121212]', border: 'border-white/10', subtext: 'text-zinc-500', glass: 'bg-black/60', input: 'bg-[#1C1C1E]', dock: 'bg-[#121212]/90' },
            deep: { bg: 'bg-[#0a0a0c]', text: 'text-zinc-100', card: 'bg-[#161618]', border: 'border-white/5', subtext: 'text-zinc-400', glass: 'bg-[#0a0a0c]/80', input: 'bg-[#202022]', dock: 'bg-[#161618]/90' },
            light: { bg: 'bg-[#f5f5f7]', text: 'text-black', card: 'bg-white', border: 'border-black/5', subtext: 'text-zinc-500', glass: 'bg-[#f5f5f7]/80', input: 'bg-white', dock: 'bg-white/80' }
        };

        const openSystemLink = (url) => {
            playSound('open');
            if (!url) return alert("Link indisponível.");
            window.open(url, '_blank');
        };

        const toLocalDatetimeString = (timestamp) => {
            if (!timestamp) return "";
            const date = new Date(timestamp);
            const pad = (n) => n.toString().padStart(2, '0');
            return `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())}T${pad(date.getHours())}:${pad(date.getMinutes())}`;
        };

        // --- COMPONENTS ---

        function Icon({ name, size = 24, className = "", style = {} }) {
            const containerRef = useRef(null);
            useEffect(() => {
                if (window.lucide && containerRef.current && name) {
                    const kebabName = name.replace(/([a-z0-9])([A-Z])/g, '$1-$2').toLowerCase();
                    containerRef.current.innerHTML = `<i data-lucide="${kebabName}"></i>`;
                    window.lucide.createIcons({ root: containerRef.current, attrs: { strokeWidth: 2.5, width: size, height: size, class: className, style: style } });
                }
            }, [name, size, className, style]);
            return <span ref={containerRef} className="flex items-center justify-center pointer-events-none"></span>;
        }

        // --- NEXUSBOT 2.0 (Mais Fluido) ---
        function NexusBot({ mode = 'static', message, accentColor, onComplete }) {
            const [stage, setStage] = useState('enter');

            useEffect(() => {
                if (mode === 'greeting') {
                    const t1 = setTimeout(() => setStage('active'), 100);
                    const t2 = setTimeout(() => setStage('leave'), 2500);
                    const t3 = setTimeout(onComplete, 3200);
                    return () => { clearTimeout(t1); clearTimeout(t2); clearTimeout(t3); };
                }
            }, [mode]);

            const isLeaving = stage === 'leave';
            
            return (
                <div className={`fixed inset-0 z-[9999] flex items-center justify-center pointer-events-none transition-opacity duration-500 ${isLeaving ? 'opacity-0' : 'opacity-100'} ${mode === 'greeting' ? 'bg-black/90 backdrop-blur-xl' : ''}`}>
                    <div className={`flex flex-col items-center transition-all duration-700 ${stage === 'enter' ? 'translate-y-20 opacity-0 scale-90' : isLeaving ? '-translate-y-[100vh] scale-50' : 'translate-y-0 opacity-100 scale-100'}`}>
                        {/* Bot Body */}
                        <div className="relative w-40 h-40 animate-float-smooth">
                            {/* Glow Behind */}
                            <div className="absolute inset-0 rounded-full blur-3xl opacity-30 animate-pulse" style={{ backgroundColor: accentColor }}></div>
                            
                            {/* Head Container */}
                            <div className="w-full h-full bg-zinc-900 rounded-[3rem] border border-white/10 flex items-center justify-center relative shadow-2xl overflow-hidden depth-card">
                                {/* Screen Face */}
                                <div className="w-[85%] h-[70%] bg-black rounded-[2.5rem] flex items-center justify-center gap-5 relative overflow-hidden shadow-inner flex-col border border-white/5">
                                    <div className="flex gap-5 items-center justify-center w-full h-full">
                                        <div className="w-8 h-12 rounded-full transition-all duration-300 animate-[blink_3s_infinite]" style={{ backgroundColor: accentColor, boxShadow: `0 0 15px ${accentColor}` }}></div>
                                        <div className="w-8 h-12 rounded-full transition-all duration-300 animate-[blink_3s_infinite_0.2s]" style={{ backgroundColor: accentColor, boxShadow: `0 0 15px ${accentColor}` }}></div>
                                    </div>
                                    {/* Scanline */}
                                    <div className="absolute inset-0 bg-gradient-to-b from-transparent via-white/5 to-transparent animate-[scan_2s_linear_infinite] opacity-20"></div>
                                </div>
                            </div>
                        </div>

                        {/* Text */}
                        {message && (
                            <div className="mt-8 bg-zinc-900/80 backdrop-blur-md px-8 py-4 rounded-full border border-white/10 shadow-xl text-center transition-all duration-500 animate-spring-up">
                                <p className="text-white font-bold text-xl tracking-tight" dangerouslySetInnerHTML={{ __html: message }}></p>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        function IOSSwitch({ checked, onChange, accentColor }) {
            return (
                <div 
                    onClick={() => { playSound('click'); onChange(!checked); }}
                    className={`relative w-[52px] h-[32px] rounded-full transition-all duration-300 cursor-pointer border ${checked ? 'border-transparent' : 'border-zinc-700'}`}
                    style={{ backgroundColor: checked ? accentColor : '#27272a' }}
                >
                    <div className={`absolute top-[2px] w-[26px] h-[26px] bg-white rounded-full shadow-lg transition-all duration-500 cubic-bezier(0.34, 1.56, 0.64, 1) ${checked ? 'translate-x-[22px]' : 'translate-x-[2px]'}`}></div>
                </div>
            );
        }

        // --- NEW LOGIN DESIGN (Rounded) ---
        function LoginView({ onLogin, accentColor }) {
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [loading, setLoading] = useState(false);
            const [mode, setMode] = useState('login'); // login | register

            const handleAction = async (e) => {
                e.preventDefault();
                playSound('click');
                setLoading(true);
                // Simulação simples ou lógica real Firebase
                setTimeout(async () => {
                    try {
                        if (mode === 'login') {
                             if(username === 'DN' && password === 'dnvy2205ZX@') { onLogin(true, username); return; }
                             const doc = await db.collection('artifacts').doc(DB_APP_ID).collection('public').doc('accounts').collection('users').doc(username).get();
                             if (doc.exists && doc.data().password === password) { playSound('success'); onLogin(false, username, doc.data().image); }
                             else { playSound('lock'); alert("Dados incorretos."); }
                        } else {
                            const ref = db.collection('artifacts').doc(DB_APP_ID).collection('public').doc('accounts').collection('users').doc(username);
                            const doc = await ref.get();
                            if(doc.exists) alert("Usuário já existe.");
                            else {
                                await ref.set({ password, createdAt: Date.now(), image: '' });
                                playSound('success');
                                alert("Criado! Faça login.");
                                setMode('login');
                            }
                        }
                    } catch(e) { alert("Erro de conexão."); } finally { setLoading(false); }
                }, 800);
            };

            return (
                <div className="fixed inset-0 bg-black flex flex-col items-center justify-center p-6 relative overflow-hidden">
                    {/* Background Gradients */}
                    <div className="absolute top-[-20%] left-[-20%] w-[500px] h-[500px] rounded-full blur-[120px] opacity-20 animate-pulse" style={{ background: accentColor }}></div>
                    <div className="absolute bottom-[-20%] right-[-20%] w-[500px] h-[500px] rounded-full bg-purple-600/20 blur-[120px] animate-pulse"></div>

                    <div className="w-full max-w-sm z-10 flex flex-col gap-8 animate-spring-up">
                        <div className="text-center">
                            <div className="w-24 h-24 mx-auto mb-6 bg-gradient-to-tr from-zinc-800 to-black rounded-[2rem] border border-white/10 shadow-2xl flex items-center justify-center depth-card relative group">
                                <div className="absolute inset-0 rounded-[2rem] opacity-30 blur-lg transition-opacity duration-500 group-hover:opacity-60" style={{ background: accentColor }}></div>
                                <img src="https://cdn-icons-png.flaticon.com/512/4712/4712109.png" className="w-14 h-14 relative z-10 drop-shadow-lg" />
                            </div>
                            <h1 className="text-4xl font-extrabold tracking-tight mb-2">Nexus Hub</h1>
                            <p className="text-zinc-500 font-medium">Sua experiência digital definitiva.</p>
                        </div>

                        <form onSubmit={handleAction} className="flex flex-col gap-4">
                            <div className="flex flex-col gap-3">
                                <div className="relative group">
                                    <div className="absolute inset-y-0 left-5 flex items-center text-zinc-500"><Icon name="User" size={18} /></div>
                                    <input 
                                        type="text" placeholder="Usuário" required
                                        value={username} onChange={e => setUsername(e.target.value)}
                                        className="w-full bg-zinc-900/80 border border-zinc-800 rounded-full py-4 pl-12 pr-6 text-white outline-none focus:border-white/30 focus:bg-black transition-all shadow-inner font-medium placeholder:text-zinc-600"
                                    />
                                </div>
                                <div className="relative group">
                                    <div className="absolute inset-y-0 left-5 flex items-center text-zinc-500"><Icon name="Lock" size={18} /></div>
                                    <input 
                                        type="password" placeholder="Senha" required
                                        value={password} onChange={e => setPassword(e.target.value)}
                                        className="w-full bg-zinc-900/80 border border-zinc-800 rounded-full py-4 pl-12 pr-6 text-white outline-none focus:border-white/30 focus:bg-black transition-all shadow-inner font-medium placeholder:text-zinc-600"
                                    />
                                </div>
                            </div>

                            <button type="submit" style={{ background: accentColor, boxShadow: `0 10px 30px -10px ${accentColor}80` }} className="w-full py-4 rounded-full font-bold text-white text-lg tracking-wide btn-press mt-2 relative overflow-hidden">
                                {loading ? <span className="animate-pulse">Autenticando...</span> : (mode === 'login' ? 'Entrar' : 'Criar Conta')}
                            </button>
                        </form>

                        <div className="flex justify-center mt-4">
                            <button onClick={() => setMode(mode === 'login' ? 'register' : 'login')} className="text-sm font-semibold text-zinc-500 hover:text-white transition-colors">
                                {mode === 'login' ? 'Não tem conta? Cadastre-se' : 'Já tem conta? Entrar'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        // --- NEW WIDGETS ---
        
        function WidgetSmall({ items, onApp, accentColor }) {
            // Um widget 2x2 que exibe 4 ícones pequenos
            if (!items || items.length === 0) return null;
            return (
                <div className="bg-zinc-900/50 border border-white/5 p-3 rounded-[32px] w-full aspect-square flex flex-col gap-2 justify-between backdrop-blur-md shadow-lg overflow-hidden relative group">
                     {/* Glass Overlay */}
                     <div className="absolute inset-0 bg-gradient-to-br from-white/5 to-transparent pointer-events-none"></div>
                     <div className="grid grid-cols-2 gap-2 h-full">
                         {items.slice(0, 4).map((app, i) => (
                             <div key={i} onClick={() => onApp(app)} className="bg-zinc-800/80 rounded-[18px] flex items-center justify-center relative active:scale-90 transition-transform cursor-pointer overflow-hidden border border-white/5">
                                 {app ? <img src={app.icon} className="w-full h-full object-cover opacity-90 group-hover:opacity-100 transition-opacity" /> : <div className="bg-zinc-800 w-full h-full"></div>}
                             </div>
                         ))}
                     </div>
                </div>
            );
        }

        function AppListItem({ app, onClick, isLocked, accentColor, themeMode }) {
            const colors = THEMES[themeMode];
            return (
                <div onClick={() => { playSound('click'); onClick(app); }} className="flex items-center gap-4 py-3 active:scale-[0.98] transition-all cursor-pointer group">
                    <div className="relative">
                        <img src={app.icon} className="w-[64px] h-[64px] app-icon object-cover bg-zinc-800 shadow-lg group-hover:shadow-2xl transition-all duration-300" />
                        {isLocked && <div className="absolute inset-0 bg-black/60 backdrop-blur-[2px] rounded-[18px] flex items-center justify-center"><Icon name="Lock" size={18} className="text-white" /></div>}
                    </div>
                    <div className="flex-1 min-w-0 border-b border-white/5 pb-3 group-last:border-0">
                        <div className="flex justify-between items-center">
                            <div>
                                <h3 className={`font-bold text-[15px] leading-tight mb-0.5 ${colors.text} truncate`}>{isLocked ? "Confidencial" : app.name}</h3>
                                <p className={`text-[12px] font-medium ${colors.subtext}`}>{isLocked ? "Em Breve" : app.category}</p>
                            </div>
                            <button style={{ backgroundColor: `${accentColor}15`, color: accentColor }} className="px-4 py-1.5 rounded-full text-[10px] font-bold uppercase tracking-wider">Obter</button>
                        </div>
                    </div>
                </div>
            );
        }

        // --- DYNAMIC HOME VIEW ---

        function TodayView({ apps, highlights, onProfile, onSettings, onApp, isAdmin, profileImage, themeMode, accentColor }) {
            const colors = THEMES[themeMode];
            const [layoutOrder, setLayoutOrder] = useState(() => {
                const saved = localStorage.getItem('nexus_layout_order');
                return saved ? JSON.parse(saved) : ['highlights', 'widgets', 'recent', 'categories'];
            });
            const [isEditingLayout, setIsEditingLayout] = useState(false);

            useEffect(() => {
                 const checkEdit = () => { if(localStorage.getItem('nexus_edit_mode') === 'true') setIsEditingLayout(true); else setIsEditingLayout(false); };
                 window.addEventListener('nexus-layout-edit', checkEdit);
                 return () => window.removeEventListener('nexus-layout-edit', checkEdit);
            }, []);

            const moveItem = (index, direction) => {
                const newOrder = [...layoutOrder];
                if (direction === 'up' && index > 0) {
                    [newOrder[index], newOrder[index - 1]] = [newOrder[index - 1], newOrder[index]];
                } else if (direction === 'down' && index < newOrder.length - 1) {
                    [newOrder[index], newOrder[index + 1]] = [newOrder[index + 1], newOrder[index]];
                }
                setLayoutOrder(newOrder);
                localStorage.setItem('nexus_layout_order', JSON.stringify(newOrder));
                playSound('pop');
            };

            const renderSection = (type, index) => {
                const ControlOverlay = () => isEditingLayout ? (
                    <div className="absolute right-0 -top-3 flex gap-1 z-20">
                        <button onClick={() => moveItem(index, 'up')} className="bg-zinc-800 p-1.5 rounded-lg border border-zinc-700 shadow-xl"><Icon name="ArrowUp" size={14} /></button>
                        <button onClick={() => moveItem(index, 'down')} className="bg-zinc-800 p-1.5 rounded-lg border border-zinc-700 shadow-xl"><Icon name="ArrowDown" size={14} /></button>
                    </div>
                ) : null;

                switch(type) {
                    case 'highlights':
                        return (
                            <div key="highlights" className="relative mb-8 animate-spring-up group" style={{ animationDelay: '0.1s' }}>
                                <ControlOverlay />
                                <div className="flex overflow-x-auto gap-4 no-scrollbar -mx-5 px-5 snap-x snap-mandatory pt-2 pb-4">
                                    {highlights.map(h => (
                                        <div key={h.id} onClick={() => { if(h.appId) onApp(apps.find(a=>a.id===h.appId)); }} className="snap-center shrink-0 w-[85vw] max-w-[320px] aspect-[4/5] rounded-[32px] overflow-hidden relative shadow-2xl active:scale-[0.98] transition-transform cursor-pointer border border-white/5">
                                            <img src={h.image} className="absolute inset-0 w-full h-full object-cover" />
                                            <div className="absolute inset-0 bg-gradient-to-t from-black/90 via-black/20 to-transparent p-6 flex flex-col justify-end">
                                                <p className="text-[10px] font-bold text-white/70 uppercase tracking-widest mb-1">{h.subtitle}</p>
                                                <h2 className="text-3xl font-extrabold text-white leading-none tracking-tight">{h.title}</h2>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        );
                    case 'widgets':
                         // Mix of Widgets and Small Blocks
                        const featuredApps = apps.slice(0, 4); 
                        const gameApps = apps.filter(a => a.category === 'Jogos').slice(0, 4);
                        return (
                            <div key="widgets" className="px-5 mb-8 relative animate-spring-up" style={{ animationDelay: '0.2s' }}>
                                <ControlOverlay />
                                <h3 className={`text-xl font-bold mb-4 ${colors.text}`}>Acesso Rápido</h3>
                                <div className="grid grid-cols-2 gap-4">
                                    <div className={`bg-gradient-to-br from-${accentColor}/20 to-zinc-900/50 p-5 rounded-[32px] border border-white/5 flex flex-col justify-between shadow-lg backdrop-blur-md`}>
                                         <div className="w-10 h-10 rounded-full bg-white/10 flex items-center justify-center mb-2"><Icon name="Zap" size={20} className="text-white" /></div>
                                         <div>
                                            <p className="text-xs font-bold opacity-60 uppercase">Destaque</p>
                                            <p className="text-lg font-bold leading-tight">Novos Jogos</p>
                                         </div>
                                    </div>
                                    <WidgetSmall items={featuredApps} onApp={onApp} accentColor={accentColor} />
                                </div>
                            </div>
                        );
                    case 'recent':
                        const recent = apps.slice(0, 5);
                        return (
                            <div key="recent" className="px-5 mb-8 relative animate-spring-up" style={{ animationDelay: '0.3s' }}>
                                <ControlOverlay />
                                <div className="flex items-center justify-between mb-2">
                                    <h3 className={`text-xl font-bold ${colors.text}`}>Adicionados Recentemente</h3>
                                </div>
                                <div className="space-y-1">
                                    {recent.map(app => <AppListItem key={app.id} app={app} onClick={onApp} isLocked={app.isLocked} accentColor={accentColor} themeMode={themeMode} />)}
                                </div>
                            </div>
                        );
                    case 'categories':
                        return (
                            <div key="categories" className="px-5 mb-20 relative animate-spring-up" style={{ animationDelay: '0.4s' }}>
                                <ControlOverlay />
                                <h3 className={`text-xl font-bold mb-4 ${colors.text}`}>Categorias</h3>
                                <div className="flex gap-3 overflow-x-auto no-scrollbar pb-2">
                                    {['Jogos', 'Produtividade', 'Social', 'Ferramentas'].map(cat => (
                                        <div key={cat} className="px-6 py-3 rounded-2xl bg-zinc-800/50 border border-white/5 whitespace-nowrap text-sm font-bold shadow-md">{cat}</div>
                                    ))}
                                </div>
                            </div>
                        );
                    default: return null;
                }
            };

            return (
                <div className={`min-h-screen ${colors.bg} pb-32 transition-colors duration-500`}>
                    <header className={`pt-14 px-5 pb-4 flex justify-between items-center sticky top-0 z-30 ${colors.glass} backdrop-blur-xl border-b ${colors.border}`}>
                        <div>
                            <p className={`text-[11px] font-bold ${colors.subtext} uppercase tracking-wide opacity-80`}>{new Date().toLocaleDateString('pt-BR', { weekday: 'long', day: 'numeric' })}</p>
                            <h1 className={`text-3xl font-extrabold tracking-tight ${colors.text}`}>Hoje</h1>
                        </div>
                        <div className="flex gap-3">
                            {isAdmin && (
                                <button onClick={() => { playSound('click'); onSettings(); }} className={`w-10 h-10 rounded-full flex items-center justify-center bg-zinc-800/50 border ${colors.border} active:scale-90 transition-transform`}>
                                    <Icon name="Settings" size={18} className={colors.text} />
                                </button>
                            )}
                            <button onClick={() => { playSound('click'); onProfile(); }} className={`w-10 h-10 rounded-full overflow-hidden border-2 border-white/10 active:scale-90 transition-transform`}>
                                {profileImage ? <img src={profileImage} className="w-full h-full object-cover" /> : <Icon name="User" size={20} className="text-zinc-500 m-auto mt-2" />}
                            </button>
                        </div>
                    </header>
                    
                    <div className="pt-4">
                        {isEditingLayout && (
                            <div className="mx-5 mb-4 p-3 bg-yellow-500/10 border border-yellow-500/30 rounded-xl flex items-center gap-3 animate-pulse">
                                <Icon name="Edit" size={16} className="text-yellow-500" />
                                <p className="text-xs font-bold text-yellow-500">Modo de Edição Ativo. Mova os blocos.</p>
                            </div>
                        )}
                        {layoutOrder.map((type, idx) => renderSection(type, idx))}
                    </div>
                </div>
            );
        }

        // --- OTHER VIEWS (Simplified) ---
        function GenericView({ title, apps, onApp, accentColor, themeMode }) {
             return (
                <div className="pt-20 px-5 pb-32 animate-spring-up">
                    <h1 className={`text-3xl font-extrabold mb-6 ${THEMES[themeMode].text}`}>{title}</h1>
                    <div className="grid grid-cols-4 gap-4 mb-8">
                         {/* Grid de Ícones Estilo iOS */}
                         {apps.slice(0, 8).map(app => (
                             <div key={app.id} onClick={() => onApp(app)} className="flex flex-col items-center gap-2 cursor-pointer active:scale-90 transition-transform">
                                 <img src={app.icon} className="w-full aspect-square rounded-[18px] object-cover shadow-md bg-zinc-800" />
                                 <span className="text-[10px] font-medium text-center truncate w-full">{app.name}</span>
                             </div>
                         ))}
                    </div>
                    <h3 className="font-bold text-lg mb-4">Todos</h3>
                    <div className="space-y-1">
                        {apps.map(app => <AppListItem key={app.id} app={app} onClick={onApp} accentColor={accentColor} themeMode={themeMode} />)}
                    </div>
                </div>
             );
        }

        // --- SETTINGS MODAL ---
        function SettingsModal({ onClose, accentColor, themeMode, toggleEditLayout }) {
             const [editActive, setEditActive] = useState(localStorage.getItem('nexus_edit_mode') === 'true');

             const handleEditToggle = (val) => {
                 setEditActive(val);
                 localStorage.setItem('nexus_edit_mode', val);
                 window.dispatchEvent(new Event('nexus-layout-edit'));
             };

             return (
                 <div className="fixed inset-0 z-[200] bg-black/80 backdrop-blur-xl flex flex-col animate-spring-up">
                     <header className="px-6 pt-16 pb-6 flex justify-between items-center border-b border-white/10">
                         <h2 className="text-2xl font-bold text-white">Ajustes</h2>
                         <button onClick={onClose} className="w-8 h-8 rounded-full bg-zinc-800 flex items-center justify-center"><Icon name="X" size={18} /></button>
                     </header>
                     <div className="p-6 space-y-8">
                         <section>
                             <h3 className="text-xs font-bold text-zinc-500 uppercase tracking-widest mb-4">Personalização</h3>
                             <div className="bg-zinc-900/50 border border-white/5 rounded-3xl overflow-hidden">
                                 <div className="p-4 flex justify-between items-center border-b border-white/5">
                                     <div className="flex items-center gap-3">
                                         <div className="w-8 h-8 rounded-full bg-blue-500/20 flex items-center justify-center text-blue-500"><Icon name="LayoutDashboard" size={16} /></div>
                                         <span className="font-bold text-sm">Editar Layout da Home</span>
                                     </div>
                                     <IOSSwitch checked={editActive} onChange={handleEditToggle} accentColor={accentColor} />
                                 </div>
                             </div>
                         </section>
                         
                         <section>
                             <h3 className="text-xs font-bold text-zinc-500 uppercase tracking-widest mb-4">Sistema</h3>
                             <p className="text-xs text-zinc-600 text-center mt-8">Nexus OS {APP_VERSION}</p>
                         </section>
                     </div>
                 </div>
             );
        }

        // --- MAIN APP SHELL ---

        function App() {
            const [view, setView] = useState('loading');
            const [user, setUser] = useState(null);
            const [activeTab, setActiveTab] = useState('today');
            const [theme, setTheme] = useState('amoled');
            const [accentColor, setAccentColor] = useState('#2563eb');
            const [isAdmin, setIsAdmin] = useState(false);
            
            // Data
            const [apps, setApps] = useState([]);
            const [highlights, setHighlights] = useState([]);
            const [profileImage, setProfileImage] = useState(null);
            
            // UI
            const [showRobot, setShowRobot] = useState(true);
            const [showSettings, setShowSettings] = useState(false);
            const [selectedApp, setSelectedApp] = useState(null);

            useEffect(() => {
                const unsub = auth.onAuthStateChanged(u => {
                    setUser(u);
                    if(localStorage.getItem('nexus_logged_in') === 'true') {
                        setIsAdmin(localStorage.getItem('nexus_admin_status') === 'true');
                        setShowRobot(true);
                        setView('store');
                    } else setView('login');
                });
                return unsub;
            }, []);

            useEffect(() => {
                 if(!user) return;
                 // Mock Data for visual preview if DB empty, else use DB
                 const unsub = db.collection('artifacts').doc(DB_APP_ID).collection('public').doc('data').collection('apps').onSnapshot(s => {
                     const data = s.docs.map(d => ({id: d.id, ...d.data()}));
                     if(data.length > 0) setApps(data);
                     else setApps([
                         {id: '1', name: 'Spotify Mod', category: 'Music', icon: 'https://cdn-icons-png.flaticon.com/512/2111/2111624.png'},
                         {id: '2', name: 'Instagram Pro', category: 'Social', icon: 'https://cdn-icons-png.flaticon.com/512/2111/2111463.png'},
                         {id: '3', name: 'Subway Surfers', category: 'Jogos', icon: 'https://cdn-icons-png.flaticon.com/512/3408/3408506.png'},
                         {id: '4', name: 'Netflix Free', category: 'Streaming', icon: 'https://cdn-icons-png.flaticon.com/512/732/732228.png'},
                         {id: '5', name: 'Minecraft PE', category: 'Jogos', icon: 'https://cdn-icons-png.flaticon.com/512/5968/5968812.png'}
                     ]);
                 });
                 // Highlights Mock/Real
                 db.collection('artifacts').doc(DB_APP_ID).collection('public').doc('data').collection('highlights').onSnapshot(s => {
                     const data = s.docs.map(d => ({id: d.id, ...d.data()}));
                     if(data.length > 0) setHighlights(data);
                     else setHighlights([{id: 'h1', title: 'O Futuro Chegou', subtitle: 'Lançamento', image: 'https://images.unsplash.com/photo-1550745165-9bc0b252726f?auto=format&fit=crop&q=80&w=800'}]);
                 });
                 return () => unsub();
            }, [user]);

            const handleLogin = (isAdminUser, username) => {
                localStorage.setItem('nexus_logged_in', 'true');
                if(isAdminUser) localStorage.setItem('nexus_admin_status', 'true');
                setIsAdmin(isAdminUser);
                setShowRobot(true);
                setView('store');
            };

            const TabBtn = ({ id, icon, label }) => (
                <button 
                    onClick={() => { playSound('click'); setActiveTab(id); }} 
                    className={`flex flex-col items-center justify-center gap-1 transition-all duration-300 ${activeTab === id ? 'text-white scale-110' : 'text-zinc-500'}`}
                >
                    <div className="relative">
                        <Icon name={icon} size={24} style={{ color: activeTab === id ? accentColor : undefined }} strokeWidth={activeTab === id ? 3 : 2} />
                        {activeTab === id && <div className="absolute -bottom-2 left-1/2 -translate-x-1/2 w-1 h-1 rounded-full bg-current" style={{ color: accentColor }}></div>}
                    </div>
                    <span className="text-[10px] font-bold tracking-wide opacity-80">{label}</span>
                </button>
            );

            if (view === 'loading') return <div className="h-screen bg-black flex items-center justify-center"><div className="w-12 h-12 border-4 border-t-transparent rounded-full animate-spin" style={{borderColor: `${accentColor}40`, borderTopColor: accentColor}}></div></div>;
            if (view === 'login') return <LoginView onLogin={handleLogin} accentColor={accentColor} />;

            return (
                <div className="h-screen w-full bg-[#050505] text-white overflow-hidden relative font-sans selection:bg-blue-500/30">
                    
                    {showRobot && <NexusBot mode="greeting" message={`Olá, <span style="color:${accentColor}">Membro</span>`} accentColor={accentColor} onComplete={() => setShowRobot(false)} />}
                    
                    <div className="h-full overflow-y-auto no-scrollbar">
                        {activeTab === 'today' && <TodayView apps={apps} highlights={highlights} onSettings={() => setShowSettings(true)} onApp={setSelectedApp} isAdmin={isAdmin} themeMode={theme} accentColor={accentColor} />}
                        {activeTab === 'games' && <GenericView title="Jogos" apps={apps.filter(a => a.category === 'Jogos')} onApp={setSelectedApp} accentColor={accentColor} themeMode={theme} />}
                        {activeTab === 'apps' && <GenericView title="Apps" apps={apps.filter(a => a.category !== 'Jogos')} onApp={setSelectedApp} accentColor={accentColor} themeMode={theme} />}
                        {activeTab === 'search' && <div className="pt-20 px-5 text-center text-zinc-500 font-bold">Busca em desenvolvimento...</div>}
                    </div>

                    {/* DOCK FLUTUANTE COM GLASSMORPHISM */}
                    <div className="fixed bottom-6 left-1/2 -translate-x-1/2 w-[90%] max-w-sm glass-panel rounded-[2rem] p-4 flex justify-around items-center z-50 animate-spring-up border-t border-white/10 shadow-2xl">
                        <TabBtn id="today" icon="LayoutGrid" label="Hoje" />
                        <TabBtn id="games" icon="Gamepad2" label="Jogos" />
                        <TabBtn id="apps" icon="AppWindow" label="Apps" />
                        <TabBtn id="search" icon="Search" label="Busca" />
                    </div>

                    {showSettings && <SettingsModal onClose={() => setShowSettings(false)} accentColor={accentColor} />}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
